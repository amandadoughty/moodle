define(["jquery"],function(f){return{initialise:function(){f(document).ready(function(){var e=f("#region-main"),a=f("#add_notification_wrapper_id"),s={save:"Save",update:"Update",req:"Required...",preview:"Preview",title:"Title",message:"Message"};e.on("click",".notifications_table tr > td > form > button[type=submit]",function(e){e.preventDefault();var a={call:"ajax",purpose:"",tableaction:""},i=f(this).closest("form").attr("data-edit"),t=f(this).closest("form").attr("data-delete");if(c(),void 0!==i&&!1!==i){a.purpose="edit",a.tableaction=i;var n=f("#add_notification_save");n.addClass("update"),n.val(s.update)}else void 0!==t&&!1!==t&&(a.purpose="delete",a.tableaction=t);var o=M.cfg.wwwroot+"/blocks/advnotifications/pages/process.php?sesskey="+M.cfg.sesskey;f.post(o,a).fail(function(){console.error("No 'manage' response received.")}).done(function(e){if(e=JSON.parse(e),0<parseInt(e.done,10))f("#tr"+a.purpose+e.done).closest("tr").fadeOut(250,function(){f(this).remove(),l(),d()});else if("edit"===a.purpose){for(var i in e)if(e.hasOwnProperty(i)){if("id"===i){var t=f("#add_notification_form");f("#add_notification_id").remove(),t.prepend('<input type="hidden" id="add_notification_id" name="id" value="'+e[i]+'"/>'),f("#add_notification_purpose").val("update")}var n=f("#add_notification_wrapper_id").find("#add_notification_"+i);"enabled"!==i&&"global"!==i&&"dismissible"!==i&&"aicon"!==i||1!=e[i]?"enabled"!==i&&"global"!==i&&"dismissible"!==i&&"aicon"!==i||0!=e[i]?n.val(e[i]):n.prop("checked",!1):n.prop("checked",!0)}r()}})}),e.on("click",".notifications_restore_table tr > td > form > button[type=submit]",function(e){e.preventDefault();var i={call:"ajax",purpose:"",tableaction:""},t=f(this).closest("form").attr("data-restore"),n=f(this).closest("form").attr("data-permdelete");void 0!==t&&!1!==t?(i.purpose="restore",i.tableaction=t):void 0!==n&&!1!==n&&(i.purpose="permdelete",i.tableaction=n);var a=M.cfg.wwwroot+"/blocks/advnotifications/pages/process.php?sesskey="+M.cfg.sesskey;f.post(a,i).fail(function(){console.error("No 'restore/permdelete' response received.")}).done(function(e){e=JSON.parse(e),0<parseInt(e.done,10)&&f("#tr"+i.purpose+e.done).closest("tr").fadeOut(250,function(){f(this).remove()})})}),a.on("click","#add_notification_cancel",function(e){e.preventDefault(),l()}),e.on("submit","#add_notification_form",function(e){e.preventDefault();var a=f("#add_notification_status"),o=f("#add_notification_form");if(c(),n()){a.show();var i=f(this).serialize(),t=M.cfg.wwwroot+"/blocks/advnotifications/pages/process.php";f.post(t,i).fail(function(e){console.error("No 'add' response received.");var i=e.responseJSON.error;for(var t in i)if(i.hasOwnProperty(t)){var n=o.find("select[name="+i[t]+"]");n.addClass("requiredfield"),f('<strong class="requiredfield"><em>'+s.req+"</em></strong>").insertAfter(n[0].nextSibling)}a.hide()}).done(function(){a.find(".saving").hide(),a.find(".done").show(),l(),setTimeout(function(){a.fadeOut(function(){a.find(".done").hide(),a.find(".saving").show()})},1500),f("#advnotifications_table_wrapper").load("# #advnotifications_table_wrapper > *")})}}),a.on("input propertychange paste","#add_notification_title, #add_notification_message",function(){r()}),f("#add_notification_type").on("change",function(){r()}),f("#add_notification_dismissible").on("change",function(){r()}),f("#add_notification_aicon").on("change",function(){r()});var i,t,r=function(){var e=a.find("#add_notification_title");0<e.val().length?a.find(".preview-title")[0].innerHTML=e.val():a.find(".preview-title")[0].innerHTML=s.title;var i=a.find("#add_notification_message");0<i.val().length?a.find(".preview-message")[0].innerHTML=i.val():a.find(".preview-message")[0].innerHTML=s.message;var t=f("#add_notification_type").val(),n=f("#add_notification_wrapper_id .preview-alert");n.removeClass("alert-info alert-success alert-danger alert-warning announcement"),"announcement"===t&&(n.addClass(t),t="info"),"info"!==t&&"success"!==t&&"warning"!==t&&"danger"!==t&&(t="info"),n.addClass("alert-"+t),f(".preview-aicon").find("> img").attr("src",M.util.image_url(t,"block_advnotifications")),f("#add_notification_dismissible")[0].checked?(f(".preview-alert-dismissible").show(),n.addClass("dismissible")):(f(".preview-alert-dismissible").hide(),n.removeClass("dismissible")),f("#add_notification_aicon")[0].checked?(f(".preview-aicon").show(),n.addClass("aicon")):(f(".preview-aicon").hide(),n.removeClass("aicon"))},d=function(){var e=f("#notification_preview_wrapper"),i='<div id="notification_preview_wrapper"><strong>'+s.preview+'</strong><br><div class="alert alert-info preview-alert"><div class="preview-aicon" style="display: none;"><img src="'+M.util.image_url("info","block_advnotifications")+'" /></div><strong class="preview-title">'+s.title+'</strong> <div class="preview-message">'+s.message+'</div> <div class="preview-alert-dismissible" style="display: none;"><strong>&times;</strong></div></div></div>';0<e.length?(e.remove(),f(i).prependTo(f(a))):f(i).prependTo(f(a)).hide().slideDown()},n=function(){var e=f("#add_notification_form select option:selected:disabled");for(var i in e)if(e.hasOwnProperty(i)&&f(e[i]).prop("disabled"))return f(e[i]).closest("select").addClass("requiredfield"),f('<strong class="requiredfield"><em>'+s.req+"</em></strong>").insertAfter(f(e[i]).closest("select")[0].nextSibling),!1;return!0},c=function(){f("select.requiredfield").removeClass("requiredfield"),f("strong.requiredfield").remove()},l=function(){f("#add_notification_form")[0].reset(),c(),d();var e=f("#add_notification_save");e.removeClass("update"),f("#add_notification_id").remove(),f("#add_notification_purpose").val("add"),e.val(s.save)};i={call:"ajax",purpose:"strings"},t=M.cfg.wwwroot+"/blocks/advnotifications/pages/process.php?sesskey="+M.cfg.sesskey,f.post(t,i).fail(function(){console.error("No 'strings' response received.")}).done(function(e){s=e}).always(function(){d()}),f("#add_notification_form").append('<input type="hidden" id="add_notification_call" name="call" value="ajax"/>')})}}});