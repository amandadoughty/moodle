define(["jquery","core/ajax","core/templates","core/str","core/url","core/yui","core/notification"],function(a,b,c,d,e,f,g){var h={CONTENTNODE:"content",COLLAPSEALL:"culcollapse-all",DISABLED:"disabled",LOADED:"loaded",NOTLOADED:"notloaded",SECTIONCOLLAPSED:"collapsed",HASCHILDREN:"with_children",HIDE:"hide"},i={LOADEDTREES:".with_children.loaded",CONTENTNODE:".content",CATEGORYCHILDLINK:".culcategory .info .categoryname a",CATEGORYLISTENLINK:".culcategory .info .categoryname",CATEGORYSPINNERLOCATION:".categoryname",CATEGORYWITHCOLLAPSEDLOADEDCHILDREN:".culcategory.with_children.loaded.collapsed",CATEGORYWITHMAXIMISEDLOADEDCHILDREN:".culcategory.with_children.loaded:not(.collapsed)",COLLAPSEEXPAND:".culcollapseexpand",COURSEBOX:".culcoursebox",COURSEBOXLISTENLINK:".culcoursebox .moreinfo",COURSEBOXSPINNERLOCATION:".coursename a",COURSECATEGORYTREE:".course_category_tree",PARENTWITHCHILDREN:".culcategory",SPINNER:".progress-icon"},j=0,k=1,l=M.cfg.wwwroot+"/blocks/culcourse_listing/category_ajax.php",m=function(){f.one(f.config.doc).delegate("key",o,"enter",i.CATEGORYLISTENLINK,this),f.one(f.config.doc).delegate("key",n,"enter",i.COURSEBOXLISTENLINK,this),f.one(f.config.doc).delegate("key",r,"enter",i.COLLAPSEEXPAND,this)},n=function(a){var b;return b=a.target.ancestor(i.COURSEBOX,!0),a.preventDefault(),b.hasClass(h.LOADED)?void q(b):void p({parentnode:b,childnode:b.one(i.CONTENTNODE),spinnerhandle:i.COURSEBOXSPINNERLOCATION,spinner:i.SPINNER,data:{sesskey:M.cfg.sesskey,courseid:b.getData("courseid"),type:k}})},o=function(a){var b,c,d;if(a.target.test("a")||a.target.test("img"),b=a.target.ancestor(i.PARENTWITHCHILDREN,!0),b.hasClass(h.HASCHILDREN)){if(b.hasClass(h.LOADED))return void q(b);c=b.getData("categoryid"),d=b.getData("depth"),"undefined"!=typeof c&&"undefined"!=typeof d&&p({parentnode:b,childnode:b.one(i.CONTENTNODE),spinnerhandle:i.CATEGORYSPINNERLOCATION,spinner:i.SPINNER,data:{sesskey:M.cfg.sesskey,categoryid:c,depth:d,showcourses:b.getData("showcourses"),type:j}})}},p=function(b){var e=this;d.get_string("loading","core").then(function(a){return c.renderPix("i/progressbar","core",a)}).then(function(c){var d=b.parentnode.one(b.spinnerhandle),e=a(c).addClass("progress-icon");return d.append(e),e}).then(function(c){var d={},f={},g=a("#culcourse_listing_filter_year"),h=a("#culcourse_listing_filter_period");g&&(a.each(g.attr("options"),function(a,b){d[b]=a}),b.data.years=JSON.stringify(d)),h&&(a.each(h.attr("options"),function(a,b){f[b]=a}),b.data.periods=JSON.stringify(f));var i={parentnode:b.parentnode,childnode:b.childnode,spinnernode:c};a.ajax({url:l,method:"POST",data:b.data,context:e,success:function(a){v(a,i)}})}).fail(g.exception)},q=function(a){var b=a.one(i.CONTENTNODE),c=this,d=a.ancestor(i.COURSECATEGORYTREE);w(b),a.hasClass(h.SECTIONCOLLAPSED)?(b.setStyle("height","0"),a.removeClass(h.SECTIONCOLLAPSED),a.setAttribute("aria-expanded","true"),b.fx.set("reverse",!1)):(b.fx.set("reverse",!0),b.fx.once("end",function(a,b){b.addClass(h.SECTIONCOLLAPSED),b.setAttribute("aria-expanded","false")},this,a)),b.fx.once("end",function(a,b){b.setStyles({height:"",opacity:""}),this.destroy(),c.update_collapsible_actions(d)},b.fx,b),b.fx.run()},r=function(a){if(a.preventDefault(),!a.currentTarget.hasClass(h.DISABLED)){var b=a.currentTarget.ancestor(i.COURSECATEGORYTREE);if(b){var c=b.one(i.COLLAPSEEXPAND);c.hasClass(h.COLLAPSEALL)?t(b):s(b),u(b)}}},s=function(a){var b=[];a.all(i.CATEGORYWITHCOLLAPSEDLOADEDCHILDREN).each(function(a){a.ancestor(i.CATEGORYWITHCOLLAPSEDLOADEDCHILDREN)?(a.removeClass(h.SECTIONCOLLAPSED),a.all(i.LOADEDTREES).removeClass(h.SECTIONCOLLAPSED)):b.push(a)},this),f.all(b).each(function(a){q(a)},this)},t=function(a){var b=[];a.all(i.CATEGORYWITHMAXIMISEDLOADEDCHILDREN).each(function(a){a.ancestor(i.CATEGORYWITHMAXIMISEDLOADEDCHILDREN)?b.push(a):q(a)},this),f.all(b).each(function(a){a.addClass(h.SECTIONCOLLAPSED),a.all(i.LOADEDTREES).addClass(h.SECTIONCOLLAPSED)},this)},u=function(a){if(a){var b=!1,c=a.one(i.COLLAPSEEXPAND);c&&(a.all(i.CATEGORYWITHMAXIMISEDLOADEDCHILDREN).each(function(a){return!a.ancestor(i.CATEGORYWITHCOLLAPSEDLOADEDCHILDREN)&&(b=!0,!0)},this),c.removeClass(h.HIDE),b?c.setHTML(M.util.get_string("collapseall","moodle")).addClass(h.COLLAPSEALL).removeClass(h.DISABLED):c.setHTML(M.util.get_string("expandall","moodle")).removeClass(h.COLLAPSEALL).removeClass(h.DISABLED))}},v=function(a,b){var c;try{if(a.error)return new M.core.ajaxException(a)}catch(d){return new M.core.exception(d)}if(c=f.Node.create(a.content),b.childnode.appendChild(c),b.parentnode.addClass(h.LOADED).removeClass(h.NOTLOADED),q(b.parentnode),a.filterform){var e=f.one(".filter");e.setHTML(a.filterform)}b.spinnernode&&b.spinnernode.hide()},w=function(a){return"undefined"!=typeof a.fx?a:(a.plug(f.Plugin.NodeFX,{from:{height:0,opacity:0},to:{height:function(a){return a.get("scrollHeight")},opacity:1},duration:.2}),a)};return{initializer:function(a){this.BLOCKCONFIG=a.config;var b=f.one(f.config.doc);b.delegate("click",function(a){a.preventDefault()},i.CATEGORYCHILDLINK,this),b.delegate("click",o,i.CATEGORYLISTENLINK,this),b.delegate("click",n,i.COURSEBOXLISTENLINK,this),b.delegate("click",r,i.COLLAPSEEXPAND,this),b.once("key",m,"tab",this)}}});