define(["jquery","core/ajax","core/templates","core/notification","core/str","core/yui","core/pubsub","core_course/events","block_culcourse_listing/favourite","block_myoverview/main","block_starredcourses/main"],function(a,b,c,d,e,f,g,h,i,j,k){var l={COURSEBOXLIST:".block_culcourse_listing .course_category_tree",COURSEBOXLISTCOURSEBOX:".course_category_tree .culcoursebox",FAVOURITELIST:".favourite_list",FAVOURITECOURSEBOX:".favourite_list .culcoursebox",FAVOURITELINK:".favouritelink",FAVOURITEICON:".favouritelink i",FAVOURITECLEARBUTTON:".block_culcourse_listing #clearfavourites",FAVOURITEREORDERBUTTON:".block_culcourse_listing #reorderfavourites",FAVOURITEALERT:".block_culcourse_listing .favourite_list span"},m=M.cfg.wwwroot+"/blocks/culcourse_listing/favourite_ajax.php",n=M.cfg.wwwroot+"/blocks/culcourse_listing/favouriteapi_ajax.php",o=!1,p=function(b){if(b.preventDefault(),!o){o=!0;var c=b.target.get("parentNode"),e=c.get("href").split("?"),g=e[1];f.use("querystring-parse","event-custom",function(){var b=f.QueryString.parse(g);a.ajax({url:m,method:"POST",data:b,context:self,success:function(a){q(a,b)},error:function(){},complete:function(){o=!1,f.fire("culcourse-listing:update-favourites");var b=a(".block_myoverview .block-myoverview");a.each(b,function(a,b){j.init(b)});var b=a(".block_starredcourses .block-starredcourses");a.each(b,function(a,b){k.init(b)})}}).fail(d.exception)})}},q=function(b,g){c.render("block_culcourse_listing/coursebox",b).then(function(b){var c=a(b),h=a(b);if("add"==g.action){var j=a(l.COURSEBOXLIST+' [data-courseid="'+g.cid+'"]');j&&j.replaceWith(c),h.css("opacity",0),a(l.FAVOURITELIST).append(h);var k=f.one(l.FAVOURITELIST+' [data-courseid="'+g.cid+'"]'),m={node:k};return i.initializer(m),a(l.FAVOURITECOURSEBOX).length>0&&(a(l.FAVOURITECLEARBUTTON).show().css("display","inline-block"),a(l.FAVOURITEREORDERBUTTON).show().css("display","inline-block"),a(l.FAVOURITEALERT).text("")),void h.animate({opacity:1},1e3,function(){})}e.get_string("nofavourites","block_culcourse_listing").then(function(b){var d=a(l.COURSEBOXLIST+' [data-courseid="'+g.cid+'"]'),e=a(l.FAVOURITELIST+' [data-courseid="'+g.cid+'"]');e.animate({opacity:0},1e3,function(){this.remove(),0==a(l.FAVOURITECOURSEBOX).length&&(a(l.FAVOURITECLEARBUTTON).hide(),a(l.FAVOURITEREORDERBUTTON).hide(),a(l.FAVOURITEALERT).html("<span>"+b+"</span>"))}),d&&d.replaceWith(c)})["catch"](d.exception)}).fail(d.exception)},r=function(){a.ajax({url:n,method:"POST",data:{sesskey:M.cfg.sesskey},context:self,success:function(a){return!!a.data&&(q(a.data,a),!0)},error:function(a){d.addNotification({message:a.error,type:"error"})}}).fail(d.exception)};return{initializer:function(){var a=f.one(f.config.doc);a.delegate("click",p,l.FAVOURITELINK,this),f.publish("culcourse-listing:update-favourites",{broadcast:2}),g.subscribe(h.favourited,function(){r()}),g.subscribe(h.unfavorited,function(){r()})}}});