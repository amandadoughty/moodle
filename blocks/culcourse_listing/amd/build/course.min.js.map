{"version":3,"sources":["../src/course.js"],"names":["define","$","Ajax","Templates","Notification","Str","Y","PubSub","CourseEvents","Favourite","MyOverview","StarredCourses","SELECTORS","COURSEBOXLIST","COURSEBOXLISTCOURSEBOX","FAVOURITELIST","FAVOURITECOURSEBOX","FAVOURITELINK","FAVOURITEICON","FAVOURITECLEARBUTTON","FAVOURITEREORDERBUTTON","FAVOURITEALERT","URL","M","cfg","wwwroot","APIURL","window","editrunning","editfavourite","e","preventDefault","link","target","get","href","split","querystring","use","params","QueryString","parse","ajax","url","method","data","context","self","success","response","error","alert","editfavouritesuccess","complete","fire","roots","each","id","node","init","fail","exception","render","then","html","newcourseboxnode","newfavouritenode","action","courseboxnode","cid","replaceWith","css","append","newfavourite","one","initializer","length","show","text","animate","opacity","get_string","langstring","favouritenode","remove","hide","catch","updateFavouriteViaApi","courseid","sesskey","addNotification","message","type","doc","config","delegate","publish","broadcast","subscribe","favourited","unfavorited"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A javascript module to ...\n *\n * @package    block_culcourse_listing\n * @copyright  2019 Amanda Doughty\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/notification', 'core/str', 'core/yui',\n        'core/pubsub', 'core_course/events', 'block_culcourse_listing/favourite',\n        'block_myoverview/main', 'block_starredcourses/main'],\n    function($, Ajax, Templates, Notification, Str, Y, PubSub, CourseEvents, Favourite,\n        MyOverview, StarredCourses) {\n\n    var SELECTORS = {\n            COURSEBOXLIST: '.block_culcourse_listing .course_category_tree',\n            COURSEBOXLISTCOURSEBOX: '.course_category_tree .culcoursebox',\n            FAVOURITELIST: '.favourite_list',\n            FAVOURITECOURSEBOX: '.favourite_list .culcoursebox',\n            FAVOURITELINK: '.favouritelink i',\n            FAVOURITEICON: '.favouritelink i',\n            FAVOURITECLEARBUTTON: '.block_culcourse_listing #clearfavourites',\n            FAVOURITEREORDERBUTTON: '.block_culcourse_listing #reorderfavourites',\n            FAVOURITEALERT: '.block_culcourse_listing .favourite_list span',\n        };\n    var URL = M.cfg.wwwroot + '/blocks/culcourse_listing/favourite_ajax.php';\n    var APIURL = M.cfg.wwwroot + '/blocks/culcourse_listing/favouriteapi_ajax.php';\n    window.editrunning = false;\n\n    var editfavourite = function (e) {\n        e.preventDefault();\n\n        if (window.editrunning) {\n            return;\n        }\n\n        window.editrunning = true;\n        var link = e.target.get('parentNode');\n        var href = link.get('href').split('?');\n        var querystring = href[1];\n\n        Y.use('querystring-parse', 'event-custom', function() {\n            // returns an object with params as attributes\n            var params = Y.QueryString.parse(querystring);\n\n            $.ajax({\n                url: URL,\n                method: 'POST',\n                data: params,\n                context: self,\n                success: function(response) {\n                    if (response.error) {\n                        // throw response.error;\n                        Notification.alert(\n                            null,\n                            response.error\n                        );\n                    } else {\n                        editfavouritesuccess(response, params);\n                    }\n                },\n                error: function() {\n\n                },\n                complete: function() {\n                    window.editrunning = false;\n                    Y.fire('culcourse-listing:update-favourites');\n\n                    var roots = $('.block_myoverview .block-myoverview');\n                    $.each(roots, function(id, node) {\n                        MyOverview.init(node);\n                    });\n\n                    var roots = $('.block_starredcourses .block-starredcourses');\n                    $.each(roots, function(id, node) {\n                        StarredCourses.init(node);\n                    });\n                }\n            }).fail(Notification.exception);\n        });\n    };\n\n    var editfavouritesuccess = function (response, params) {\n        Templates.render('block_culcourse_listing/coursebox', response)\n            .then(function(html) {\n                var newcourseboxnode = $(html);\n                var newfavouritenode = $(html);\n\n                if (params.action == 'add') {\n                    var courseboxnode = $(SELECTORS.COURSEBOXLIST + ' [data-courseid=\"' + params.cid + '\"]');\n\n                    if (courseboxnode) {\n                        courseboxnode.replaceWith(newcourseboxnode);\n                    }\n\n                    newfavouritenode.css('opacity', 0);\n                    $(SELECTORS.FAVOURITELIST).append(newfavouritenode);\n\n                    // Add all the listeners to the new node. - delegate should remove need for this?\n                    // Keeping the YUI code to avoid complete rewrite.\n                    var newfavourite = Y.one(SELECTORS.FAVOURITELIST + ' [data-courseid=\"' + params.cid + '\"]');\n                    var config = {node: newfavourite};\n                    Favourite.initializer(config);\n\n                    // There must be at least one favourite now, so show the favourite buttons\n                    // if they are hidden and hide the 'no favourites' message.\n                    if ($(SELECTORS.FAVOURITECOURSEBOX).length > 0) {\n                        $(SELECTORS.FAVOURITECLEARBUTTON).show().css('display', 'inline-block');\n                        $(SELECTORS.FAVOURITEREORDERBUTTON).show().css('display', 'inline-block');\n                        $(SELECTORS.FAVOURITEALERT).text('');\n                    }\n\n                    newfavouritenode.animate({\n                        opacity: 1\n                    }, 1000, function() {\n                    });\n\n                    return;\n\n                } else if (params.action == 'delete') {\n                    Str.get_string('nofavourites', 'block_culcourse_listing').then(function(langstring) {\n                        var courseboxnode = $(SELECTORS.COURSEBOXLIST + ' [data-courseid=\"' + params.cid + '\"]');\n                        var favouritenode = $(SELECTORS.FAVOURITELIST + ' [data-courseid=\"' + params.cid + '\"]');\n\n                        favouritenode.animate({\n                            opacity: 0\n                        }, 1000, function() {\n                            this.remove();\n\n                            if ($(SELECTORS.FAVOURITECOURSEBOX).length == 0) {\n                                $(SELECTORS.FAVOURITECLEARBUTTON).hide();\n                                $(SELECTORS.FAVOURITEREORDERBUTTON).hide();\n                                $(SELECTORS.FAVOURITEALERT).html('<span>' + langstring + '</span>');\n                            }\n                        });\n\n                        if (courseboxnode) {\n                            courseboxnode.replaceWith(newcourseboxnode);\n                        }\n\n                        return;\n                    }).catch(Notification.exception);\n                }\n            })\n            .fail(Notification.exception);\n    };\n\n    var updateFavouriteViaApi = function(courseid, action) {\n        // Find out what changed via the api.\n        $.ajax({\n            url: APIURL,\n            method: 'POST',\n            data: {\n                sesskey: M.cfg.sesskey,\n                cid: courseid,\n                action: action\n            },\n            context: self,\n            success: function(response) {\n                if (response.data) {\n                    editfavouritesuccess(response.data, response);\n                    return true;\n                } else {\n                    return false;\n                }\n            },\n            error: function(response) {\n                Notification.addNotification({\n                    message: response.error,\n                    type: 'error'\n                });\n            },\n            complete: function() {\n                Y.fire('culcourse-listing:update-favourites');\n            }\n        }).fail(Notification.exception);\n    };\n\n    return {\n        initializer: function() {\n            var doc = Y.one(Y.config.doc);\n            doc.delegate('click', editfavourite, SELECTORS.FAVOURITELINK, this);\n\n            Y.publish('culcourse-listing:update-favourites', {\n                broadcast:2\n            });\n\n            /* Not useful until course id is passed. Could maybe reload favourites\n            and try and edit the course if it has been rendered */\n            PubSub.subscribe(CourseEvents.favourited, function(courseid) {updateFavouriteViaApi(courseid, 'add');});\n            PubSub.subscribe(CourseEvents.unfavorited, function(courseid) {updateFavouriteViaApi(courseid, 'delete');});\n        }\n    };\n});"],"file":"course.min.js"}