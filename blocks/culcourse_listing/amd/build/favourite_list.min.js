define(["jquery","core/ajax","core/templates","core/notification","core/str","core/url","core/yui","core/modal_factory","core/modal_events","core/key_codes","block_culcourse_listing/favourite","block_myoverview/main","block_starredcourses/main"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n={BUTTONALERT:"btn-danger",FAVOURITEADD:"fa fa-star-o",FAVOURITEREMOVE:"gold fa fa-star"},o={COURSEBOXLIST:".block_culcourse_listing  .course_category_tree",COURSEBOX:".culcoursebox",COURSEBOXSPINNERLOCATION:".coursename a",COURSEBOXLISTCOURSEBOX:".course_category_tree .culcoursebox",FAVOURITELIST:".favourite_list",FAVOURITECOURSEBOX:".favourite_list .culcoursebox",FAVOURITEICON:".favouritelink i",FAVOURITECLEARBUTTON:".block_culcourse_listing #clearfavourites",FAVOURITECLEARINPUT:".block_culcourse_listing #clearfavourites [type=submit]",FAVOURITEREORDERBUTTON:".block_culcourse_listing #reorderfavourites",FAVOURITEREORDERINPUT:".block_culcourse_listing #reorderfavourites [type=submit]"},p=M.cfg.wwwroot+"/blocks/culcourse_listing/reorderfavourites_ajax.php",q=M.cfg.wwwroot+"/blocks/culcourse_listing/clearfavourites_ajax.php",r=function(){var a=g.all(o.FAVOURITECOURSEBOX);a.each(function(a){var b={node:a};k.initializer(b)})},s=function(a){if("object"!=typeof a)return null;var b=[];for(var c in a){c=encodeURIComponent(c);var d=a[c];if(a[c]instanceof Array)for(var e in d)b.push(c+"[]="+encodeURIComponent(d[e]));else b.push(c+"="+encodeURIComponent(d))}return b.join("&")},t=function(a){a.preventDefault();var b={sesskey:M.cfg.sesskey},c={};c.message=M.util.get_string("reorderfavouritescheck","block_culcourse_listing"),c.callback=function(){g.one(o.FAVOURITELIST).transition({duration:2,easing:"ease-in",opacity:0}),g.io(p,{data:s(b),on:{success:function(a,b){g.one(o.FAVOURITELIST).replace(g.Node.create(b.responseText).setStyle("opacity",0)),r(),g.one(o.FAVOURITELIST).transition({duration:2,easing:"ease-in",opacity:1})},failure:function(){},end:function(){var a=[];g.all(o.FAVOURITECOURSEBOX).each(function(b){a.push(b.getData("courseid"))}),g.fire("culcourse-listing:update-favourites",{favourites:a})}}})},M.util.show_confirm_dialog(a,c)},u=function(b){b.preventDefault();var c={sesskey:M.cfg.sesskey},d={};d.message=M.util.get_string("clearfavouritescheck","block_culcourse_listing"),d.scope=this,d.callback=function(){g.io(q,{context:this,data:s(c),on:{success:function(){g.all(o.FAVOURITECOURSEBOX).remove();var b=g.all(o.FAVOURITEICON);b.each(function(a){var b=a.get("parentNode"),c=b.get("href").split("?"),d=c[0],e=c[1],f=d+"?"+e.replace("remove","add"),g=M.util.get_string("favouriteadd","block_culcourse_listing");b.set("href",f),b.set("title",g),a.removeClass(n.FAVOURITEREMOVE),a.addClass(n.FAVOURITEADD)}),g.all(o.COURSEBOXSPINNERLOCATION).transition({duration:2,easing:"ease-in",opacity:1}),a(o.FAVOURITECLEARBUTTON).hide(),a(o.FAVOURITEREORDERBUTTON).hide(),a(o.FAVOURITELIST).html("<span>"+M.util.get_string("nofavourites","block_culcourse_listing")+"</span>")},failure:function(){},end:function(){var b=[];g.fire("culcourse-listing:update-favourites",{favourites:b});var c=a(".block_myoverview .block-myoverview");a.each(c,function(a,b){l.init(b)});var c=a(".block_starredcourses .block-starredcourses");a.each(c,function(a,b){m.init(b)})}}})},M.util.show_confirm_dialog(b,d)};return{initializer:function(){r(),g.one(o.FAVOURITEREORDERINPUT).addClass(n.BUTTONALERT),g.one(o.FAVOURITECLEARINPUT).addClass(n.BUTTONALERT),g.one(o.FAVOURITEREORDERBUTTON).on("click",t,this),g.one(o.FAVOURITECLEARBUTTON).on("click",u,this),g.publish("culcourse-listing:update-favourites",{broadcast:2})}}});