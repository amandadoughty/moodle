YUI.add("moodle-atto_echo360attoplugin-button",function(e,t){var n=COMPONENT_NAME="atto_echo360attoplugin",r="",i="echo360",s=null,o=null,u={},a={};e.namespace("M.atto_echo360attoplugin").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{initializer:function(){if(this.get("disabled")){this.get("error")&&console.error(this.get("error"));return}r=this.editor._yuid;var e="echoIcon",t=this.get("ltiConfiguration"),n=JSON.parse(t),s="echo360-library-"+r,o=document.createElement("iframe");o.id=o.name=s,o.setAttribute("height","500px"),o.setAttribute("width","100%");var u=document.createElement("form");u.setAttribute("method","post"),u.setAttribute("id","echo360-form"+r),u.setAttribute("target",s),u.setAttribute("hidden","true"),u.action=n.launch_url;for(var a in n)if(n.hasOwnProperty(a)){var f=document.createElement("input");f.setAttribute("type","text"),f.setAttribute("value",n[a]),f.id=f.name=a,u.appendChild(f)}document.body.appendChild(u);var l=this.getDialogue({headerContent:M.util.get_string("dialogtitle",COMPONENT_NAME),focusAfterHide:this.editor,width:800});this._attachIframeToDialogue(l,o,u),this.addButton({icon:"ed/"+e,iconComponent:"atto_echo360attoplugin",buttonName:e,callback:this._doOpen,callbackArgs:null,name:i,tooltip:i})},_attachIframeToDialogue:function(e,t,n){e.render(),e.bodyNode.appendChild(t),n.submit(),this._browserIsIE()?n.parentNode.removeChild(n):n.remove()},_doOpen:function(e){e.preventDefault(),this._resetVariablesInScope(),a={host:this.get("host"),editor:this.editor,dialogue:this.getDialogue()},a.dialogue.show(),u[r]||window.addEventListener("message",function(e){return e.stopPropagation(),this._receiveMessage(e)}.bind(this),!0),u[r]=!0,this.markUpdated()},_receiveMessage:function(e){if(this._browserIsIE()||e.origin.includes(i)){o=e.data;if(o){var t=this._getQueryParams();if(t)switch(t.return_type){case"iframe":s='<iframe src="'+t.url+'" height="'+t.height+'" width="'+t.width+'" title="'+t.title+'"></iframe> ';break;case"url":case"lti_launch_url":s='<a href="'+t.url+'" target="_blank">'+t.title+"</a> ";break;default:console.error("Return type: "+t.return_type+" invalid"),this._resetVariablesInScope()}else console.error("No parameters returned from parsed message: "+o),this._resetVariablesInScope()}else console.error("No data returned from message: "+e),this._resetVariablesInScope();this._doInsert()}},_getQueryParams:function(){try{var e=JSON.parse('{"'+decodeURI(o.split("?")[1]).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}');return e.hasOwnProperty("url")?(e.url=decodeURIComponent(e.url),e.title=e.title||e.url,e):(console.error('Required parameter "url" missing from message: '+o),null)}catch(t){return console.error("Error caught while attempting to parse query parameters in message: "+o+"\n"+t.message),null}},_doInsert:function(){a.dialogue.hide();if(!s)return;a.editor.focus(),a.host.insertContentAtFocusPoint(s),this._resetVariablesInScope(),this.markUpdated()},_resetVariablesInScope:function(){s=null,o=null,a={}},_browserIsIE:function(){return navigator.appName=="Microsoft Internet Explorer"||!!navigator.userAgent.match(/Trident/)||!!navigator.userAgent.match(/rv:11/)||!!document.documentMode==1||navigator.userAgent.indexOf("MSIE")!=-1}},{ATTRS:{disabled:{value:!1},usercontextid:{value:null},ltiConfiguration:{value:""}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
