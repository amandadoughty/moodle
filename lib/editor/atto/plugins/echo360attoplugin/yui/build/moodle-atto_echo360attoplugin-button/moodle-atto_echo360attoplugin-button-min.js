YUI.add("moodle-atto_echo360attoplugin-button",function(e,t){var n="atto_echo360attoplugin",r="atto_echo360attoplugin",i="",s="echo360",o=null,u=null,a={},f={};e.namespace("M.atto_echo360attoplugin").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{initializer:function(){if(this.get("disabled")){this.get("error")&&console.error(this.get("error"));return}i=this.editor._yuid;var e="echoIcon",t=this.get("ltiConfiguration"),r=JSON.parse(t),o="echo360-library-"+i,u=document.createElement("iframe");u.id=u.name=o,u.setAttribute("height","500px"),u.setAttribute("width","100%");var a=document.createElement("form");a.setAttribute("method","post"),a.setAttribute("id","echo360-form"+i),a.setAttribute("target",o),a.setAttribute("hidden","true"),a.action=r.launch_url;for(var f in r)if(r.hasOwnProperty(f)){var l=document.createElement("input");l.setAttribute("type","text"),l.setAttribute("value",r[f]),l.id=l.name=f,a.appendChild(l)}document.body.appendChild(a);var c=this.getDialogue({headerContent:M.util.get_string("dialogtitle",n),focusAfterHide:this.editor,width:800});this._attachIframeToDialogue(c,u,a),this.addButton({icon:"ed/"+e,iconComponent:"atto_echo360attoplugin",buttonName:e,callback:this._doOpen,callbackArgs:null,name:s,tooltip:s})},_attachIframeToDialogue:function(e,t,n){e.render(),e.bodyNode.appendChild(t),n.submit(),this._browserIsIE()?n.parentNode.removeChild(n):n.remove()},_doOpen:function(e){e.preventDefault(),this._resetVariablesInScope(),f={host:this.get("host"),editor:this.editor,dialogue:this.getDialogue()},f.dialogue.show(),a[i]||window.addEventListener("message",function(e){return e.stopPropagation(),this._receiveMessage(e)}.bind(this),!0),a[i]=!0,this.markUpdated()},_receiveMessage:function(e){u=e.data;if(u){var t=this._getQueryParams();if(t)switch(t.return_type){case"iframe":o='<iframe src="'+t.url+'" height="'+t.height+'" width="'+t.width+'" title="'+t.title+'" allowfullscreen="allowfullscreen'+'" webkitallowfullscreen="webkitallowfullscreen'+'" mozallowfullscreen="mozallowfullscreen'+'"></iframe> ';break;case"url":case"lti_launch_url":o='<a href="'+t.url+'" target="_blank">'+t.title+"</a> ";break;case"homework":o='<a href="'+echo360_filter_lti_launch_url+"?url="+encodeURIComponent(t.url)+"&cmid="+echo360_context_module_id+"&width=640"+'&height=360">'+t.title+"</a>";break;default:console.error("Return type: "+t.return_type+" invalid"),this._resetVariablesInScope()}else console.error("No parameters returned from parsed message: "+u),this._resetVariablesInScope()}else console.error("No data returned from message: "+e),this._resetVariablesInScope();this._doInsert()},_getQueryParams:function(){try{var e=JSON.parse('{"'+decodeURI(u.split("?")[1]).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}');return e.hasOwnProperty("url")?(e.url=decodeURIComponent(e.url),e.title=e.title||e.url,e):(console.error('Required parameter "url" missing from message: '+u),null)}catch(t){return console.error("Error caught while attempting to parse query parameters in message: "+u+"\n"+t.message),null}},_doInsert:function(){f.dialogue.hide();if(!o)return;f.editor.focus(),f.host.insertContentAtFocusPoint(o),this._resetVariablesInScope(),this.markUpdated()},_resetVariablesInScope:function(){o=null,u=null,f={}},_browserIsIE:function(){return navigator.appName==="Microsoft Internet Explorer"||!!navigator.userAgent.match(/Trident/)||!!navigator.userAgent.match(/rv:11/)||!!document.documentMode==1||navigator.userAgent.indexOf("MSIE")!==-1}},{ATTRS:{disabled:{value:!1},usercontextid:{value:null},ltiConfiguration:{value:""}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
