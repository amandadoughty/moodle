{"version":3,"sources":["../src/essayautograde.js"],"names":["define","$","STR","ESSAY","plugin","str","itemtype","itemmatch","editortype","editormaxtries","editorinterval","responsesample","responseoriginal","init","readonly","RegExp","setup_response_heights","setup_itemcounts","setup_responsesample","each","height","scrollHeight","id","get_itemcount_id","editorloaded","Deferred","check_editor","when","done","proxy","create_itemcount","setup_itemcount","response","selector","resolve","editorchecker","setInterval","find","length","clearInterval","document","getElementById","p","createElement","setAttribute","parentNode","insertBefore","nextSibling","editable","get_editable_element","keyup","show_itemcount","prop","get","i","getElementsByTagName","d","contentWindow","contentDocument","body","isContentEditable","get_textarea","get_textarea_name","textarea","attr","name","escape","regexp","replace","itemcount","val","match","text","get_strings","s","txt","hidesample","showsample","last","append","click","newtxt","oldtxt","saveresponse","hasClass","removeClass","addClass","editor","qtext","closest","r","next","is","contents","trigger"],"mappings":"AAwBAA,OAAM,uCAAC,CAAC,QAAD,CAAW,UAAX,CAAD,CAAyB,SAASC,CAAT,CAAYC,CAAZ,CAAiB,CAG5C,GAAIC,CAAAA,CAAK,CAAG,CAGNC,MAHM,CAGG,sBAHH,CAINC,GAJM,CAIA,EAJA,CAMNC,QANM,CAMK,EANL,CAONC,SAPM,CAOM,EAPN,CAQNC,UARM,CAQO,EARP,CAUNC,cAVM,CAUW,EAVX,CAWNC,cAXM,CAWW,GAXX,CAaNC,cAbM,CAaW,EAbX,CAcNC,gBAdM,CAca,EAdb,CAAZ,CAmBAT,CAAK,CAACU,IAAN,CAAa,SAASC,CAAT,CAAmBR,CAAnB,CAA6BE,CAA7B,CAAyCG,CAAzC,CAAyD,CAGlE,GAAIJ,CAAAA,CAAS,CAAG,EAAhB,CACA,OAAQD,CAAR,EACI,IAAK,OAAL,CAAcC,CAAS,CAAG,GAAZ,CAAiB,MAC/B,IAAK,OAAL,CAAcA,CAAS,CAAG,MAAZ,CAAoB,MAClC,IAAK,WAAL,CAAkBA,CAAS,CAAG,kBAAZ,CAAgC,MAClD,IAAK,YAAL,CAAmBA,CAAS,CAAG,qBAAZ,CAAmC,MAJ1D,CASAJ,CAAK,CAACG,QAAN,CAAiBA,CAAjB,CACAH,CAAK,CAACI,SAAN,CAAkB,GAAIQ,CAAAA,MAAJ,CAAWR,CAAX,CAAsB,GAAtB,CAAlB,CACAJ,CAAK,CAACK,UAAN,CAAmBA,CAAnB,CAEA,GAAIM,CAAJ,CAAc,CACVX,CAAK,CAACa,sBAAN,EACH,CAFD,IAEO,CACHb,CAAK,CAACc,gBAAN,GACAd,CAAK,CAACe,oBAAN,CAA2BP,CAA3B,CACH,CACJ,CAvBD,CAyBAR,CAAK,CAACa,sBAAN,CAA+B,UAAW,CACvCf,CAAC,CAAC,+BAAD,CAAD,CAAmCkB,IAAnC,CAAwC,UAAU,CAC9ClB,CAAC,CAAC,IAAD,CAAD,CAAQmB,MAAR,CAAe,CAAf,EACAnB,CAAC,CAAC,IAAD,CAAD,CAAQmB,MAAR,CAAe,KAAKC,YAApB,CACH,CAHD,CAIF,CALD,CAOAlB,CAAK,CAACc,gBAAN,CAAyB,UAAW,CAChChB,CAAC,CAAC,uBAAD,CAAD,CAA2BkB,IAA3B,CAAgC,UAAU,IAClCG,CAAAA,CAAE,CAAGnB,CAAK,CAACoB,gBAAN,CAAuB,IAAvB,CAD6B,CAElCC,CAAY,CAAGvB,CAAC,CAACwB,QAAF,EAFmB,CAGtCtB,CAAK,CAACuB,YAAN,CAAmB,IAAnB,CAAyBF,CAAzB,EACAvB,CAAC,CAAC0B,IAAF,CAAOH,CAAP,EAAqBI,IAArB,CAA0B3B,CAAC,CAAC4B,KAAF,CAAQ,UAAU,CACxC1B,CAAK,CAAC2B,gBAAN,CAAuB,IAAvB,CAA6BR,CAA7B,EACAnB,CAAK,CAAC4B,eAAN,CAAsB,IAAtB,CAA4BT,CAA5B,CACH,CAHyB,CAGvB,IAHuB,CAGjBA,CAHiB,CAA1B,CAIH,CARD,CAUH,CAXD,CAaAnB,CAAK,CAACuB,YAAN,CAAqB,SAASM,CAAT,CAAmBR,CAAnB,CAAiC,CAClD,GAAIS,CAAAA,CAAQ,CAAG,EAAf,CACA,OAAQ9B,CAAK,CAACK,UAAd,EACI,IAAK,MAAL,CAAayB,CAAQ,CAAG,wBAAX,CAAqC,MAClD,IAAK,SAAL,CAAgBA,CAAQ,CAAG,QAAX,CAAqB,MAFzC,CAIA,GAAc,EAAV,EAAAA,CAAJ,CAAkB,CAEdT,CAAY,CAACU,OAAb,EACH,CAHD,IAGO,CACH,GAAIC,CAAAA,CAAa,CAAGC,WAAW,CAAC,UAAW,CACvC,GAAInC,CAAC,CAAC+B,CAAD,CAAD,CAAYK,IAAZ,CAAiBJ,CAAjB,EAA2BK,MAA/B,CAAuC,CACnCC,aAAa,CAACJ,CAAD,CAAb,CACAX,CAAY,CAACU,OAAb,EACH,CACJ,CAL8B,CAK5B/B,CAAK,CAACO,cALsB,CAMlC,CACJ,CAjBD,CAmBAP,CAAK,CAAC2B,gBAAN,CAAyB,SAASE,CAAT,CAAmBV,CAAnB,CAAuB,CAC5C,GAAkC,IAA9B,GAAAkB,QAAQ,CAACC,cAAT,CAAwBnB,CAAxB,CAAJ,CAAwC,CACpC,GAAIoB,CAAAA,CAAC,CAAGF,QAAQ,CAACG,aAAT,CAAuB,GAAvB,CAAR,CACAD,CAAC,CAACE,YAAF,CAAe,IAAf,CAAqBtB,CAArB,EACAoB,CAAC,CAACE,YAAF,CAAe,OAAf,CAAwB,WAAxB,EACAZ,CAAQ,CAACa,UAAT,CAAoBC,YAApB,CAAiCJ,CAAjC,CAAoCV,CAAQ,CAACe,WAA7C,CACH,CACJ,CAPD,CASA5C,CAAK,CAAC4B,eAAN,CAAwB,SAASC,CAAT,CAAmBV,CAAnB,CAAuB,CAC3C,GAAI0B,CAAAA,CAAQ,CAAG7C,CAAK,CAAC8C,oBAAN,CAA2BjB,CAA3B,CAAf,CACA,GAAIgB,CAAJ,CAAc,CACV/C,CAAC,CAAC+C,CAAD,CAAD,CAAYE,KAAZ,CAAkB,UAAU,CACxB/C,CAAK,CAACgD,cAAN,CAAqB,IAArB,CAA2B7B,CAA3B,CACH,CAFD,EAGAnB,CAAK,CAACgD,cAAN,CAAqBH,CAArB,CAA+B1B,CAA/B,CACH,CACJ,CARD,CAUAnB,CAAK,CAAC8C,oBAAN,CAA6B,SAASjB,CAAT,CAAmB,CAE5C,GAAiC,UAA7B,EAAA/B,CAAC,CAAC+B,CAAD,CAAD,CAAYoB,IAAZ,CAAiB,SAAjB,CAAJ,CAA6C,CACzC,MAAOpB,CAAAA,CACV,CAED,GAAIgB,CAAAA,CAAQ,CAAG/C,CAAC,CAAC+B,CAAD,CAAD,CAAYK,IAAZ,CAAiB,wBAAjB,CAAf,CACA,GAAIW,CAAQ,CAACV,MAAb,CAAqB,CACjB,MAAOU,CAAAA,CAAQ,CAACK,GAAT,CAAa,CAAb,CACV,CAED,GAAIC,CAAAA,CAAC,CAAGtB,CAAQ,CAACuB,oBAAT,CAA8B,QAA9B,CAAR,CACA,GAAID,CAAC,CAAChB,MAAN,CAAc,CACVgB,CAAC,CAAGA,CAAC,CAAC,CAAD,CAAL,CACA,GAAIE,CAAAA,CAAC,CAAIF,CAAC,CAACG,aAAF,EAAmBH,CAAC,CAACI,eAA9B,CACA,GAAIF,CAAC,CAAChB,QAAN,CAAgB,CACZgB,CAAC,CAAGA,CAAC,CAAChB,QACT,CACD,GAAIgB,CAAC,CAACG,IAAF,EAAUH,CAAC,CAACG,IAAF,CAAOC,iBAArB,CAAwC,CACpC,MAAOJ,CAAAA,CAAC,CAACG,IACZ,CACJ,CAED,GAAIX,CAAAA,CAAQ,CAAG/C,CAAC,CAAC+B,CAAD,CAAD,CAAYK,IAAZ,CAAiB,UAAjB,CAAf,CACA,GAAIW,CAAQ,CAACV,MAAb,CAAqB,CACjB,MAAOU,CAAAA,CAAQ,CAACK,GAAT,CAAa,CAAb,CACV,CAED,MAAO,KACV,CA7BD,CA+BAlD,CAAK,CAAC0D,YAAN,CAAqB,SAAS7B,CAAT,CAAmB,CACpC,GAAiC,UAA7B,EAAA/B,CAAC,CAAC+B,CAAD,CAAD,CAAYoB,IAAZ,CAAiB,SAAjB,CAAJ,CAA6C,CACzC,MAAOpB,CAAAA,CACV,CACD,MAAO/B,CAAAA,CAAC,CAAC+B,CAAD,CAAD,CAAYK,IAAZ,CAAiB,UAAjB,EAA6BgB,GAA7B,CAAiC,CAAjC,CACV,CALD,CAOAlD,CAAK,CAAC2D,iBAAN,CAA0B,SAAS9B,CAAT,CAAmB,CACzC,GAAI+B,CAAAA,CAAQ,CAAG5D,CAAK,CAAC0D,YAAN,CAAmB7B,CAAnB,CAAf,CACA,MAAO/B,CAAAA,CAAC,CAAC8D,CAAD,CAAD,CAAYC,IAAZ,CAAiB,MAAjB,CACV,CAHD,CAKA7D,CAAK,CAACoB,gBAAN,CAAyB,SAASS,CAAT,CAAmB,CACxC,GAAIiC,CAAAA,CAAI,CAAG9D,CAAK,CAAC2D,iBAAN,CAAwB9B,CAAxB,CAAX,CACA,MAAO,MAAQiC,CAAR,CAAe,YACzB,CAHD,CAKA9D,CAAK,CAAC+D,MAAN,CAAe,SAAS5C,CAAT,CAAa,CACxB,GAAI6C,CAAAA,CAAM,sBAAV,CACA,MAAO,IAAM7C,CAAE,CAAC8C,OAAH,CAAWD,CAAX,CAAmB,MAAnB,CAChB,CAHD,CAKAhE,CAAK,CAACgD,cAAN,CAAuB,SAASnB,CAAT,CAAmBV,CAAnB,CAAuB,CAC1C,GAAiC,UAA7B,EAAArB,CAAC,CAAC+B,CAAD,CAAD,CAAYoB,IAAZ,CAAiB,SAAjB,CAAJ,CAA6C,CACzC,GAAIiB,CAAAA,CAAS,CAAGpE,CAAC,CAAC+B,CAAD,CAAD,CAAYsC,GAAZ,GAAkBC,KAAlB,CAAwBpE,CAAK,CAACI,SAA9B,CACnB,CAFD,IAEO,CACH,GAAI8D,CAAAA,CAAS,CAAGpE,CAAC,CAAC+B,CAAD,CAAD,CAAYwC,IAAZ,GAAmBD,KAAnB,CAAyBpE,CAAK,CAACI,SAA/B,CACnB,CACD,GAAI8D,CAAJ,CAAe,CACXA,CAAS,CAAGA,CAAS,CAAC/B,MACzB,CAFD,IAEO,CACH+B,CAAS,CAAG,CACf,CAGDnE,CAAG,CAACuE,WAAJ,CAAgB,CACZ,CAAC,IAAOtE,CAAK,CAACG,QAAd,CAAwB,UAAaH,CAAK,CAACC,MAA3C,CADY,CAAhB,EAEGwB,IAFH,CAEQ,SAAS8C,CAAT,CAAY,CAChBzE,CAAC,CAACE,CAAK,CAAC+D,MAAN,CAAa5C,CAAb,CAAD,CAAD,CAAoBkD,IAApB,CAAyBE,CAAC,CAAC,CAAD,CAAD,CAAO,IAAP,CAAcL,CAAvC,CACH,CAJD,CAKH,CAlBD,CAoBAlE,CAAK,CAACe,oBAAN,CAA6B,SAASyD,CAAT,CAAc,CACvC,GAAS,EAAL,EAAAA,CAAJ,CAAa,CACT,MACH,CACDxE,CAAK,CAACQ,cAAN,CAAuBgE,CAAvB,CACAzE,CAAG,CAACuE,WAAJ,CAAgB,CACZ,CAAC,IAAO,YAAR,CAAsB,UAAatE,CAAK,CAACC,MAAzC,CADY,CAEZ,CAAC,IAAO,YAAR,CAAsB,UAAaD,CAAK,CAACC,MAAzC,CAFY,CAAhB,EAGGwB,IAHH,CAGQ,SAAS8C,CAAT,CAAY,CAChBvE,CAAK,CAACE,GAAN,CAAUuE,UAAV,CAAuBF,CAAC,CAAC,CAAD,CAAxB,CACAvE,CAAK,CAACE,GAAN,CAAUwE,UAAV,CAAuBH,CAAC,CAAC,CAAD,CAAxB,CACA,GAAII,CAAAA,CAAI,CAAG7E,CAAC,CAAC,QAAD,CAAD,CAAYoC,IAAZ,CAAiB,gCAAjB,CAAX,CACA,GAAIyC,CAAI,CAACxC,MAAT,CAAiB,CACbwC,CAAI,CAAGA,CAAI,CAACA,IAAL,EACV,CAFD,IAEO,CACHA,CAAI,CAAG7E,CAAC,CAAC,QAAD,CACX,CAED6E,CAAI,CAACC,MAAL,CAAY9E,CAAC,CAAC,eAAD,CAAD,CAAmB+E,KAAnB,CAAyB,UAAU,CAC3C,GAAIC,CAAAA,CAAM,CAAG,EAAb,CACIC,CAAM,CAAG,EADb,CAEIC,CAAY,GAFhB,CAGA,GAAIlF,CAAC,CAAC,IAAD,CAAD,CAAQmF,QAAR,CAAiB,YAAjB,CAAJ,CAAoC,CAChCnF,CAAC,CAAC,IAAD,CAAD,CAAQoF,WAAR,CAAoB,YAApB,EACQC,QADR,CACiB,YADjB,EAEQd,IAFR,CAEarE,CAAK,CAACE,GAAN,CAAUuE,UAFvB,EAGAK,CAAM,CAAG9E,CAAK,CAACQ,cAAf,CACAwE,CAAY,GACf,CAND,IAMO,CACHlF,CAAC,CAAC,IAAD,CAAD,CAAQoF,WAAR,CAAoB,YAApB,EACQC,QADR,CACiB,YADjB,EAEQd,IAFR,CAEarE,CAAK,CAACE,GAAN,CAAUwE,UAFvB,EAGAI,CAAM,CAAG9E,CAAK,CAACS,gBAClB,CAf0C,GAkBvC2E,CAAAA,CAAM,CAAG,IAlB8B,CAmBvCC,CAAK,CAAGvF,CAAC,CAAC,IAAD,CAAD,CAAQwF,OAAR,CAAgB,QAAhB,CAnB+B,CAoB3C,GAAsB,OAAlB,EAAAtF,CAAK,CAACK,UAAN,EAA+C,OAAlB,EAAAL,CAAK,CAACK,UAAvC,CAA4D,CACxD+E,CAAM,CAAGC,CAAK,CAACnD,IAAN,CAAW,6BAAX,CACZ,CAFD,IAEO,CACH,GAAIqD,CAAAA,CAAC,CAAGF,CAAK,CAACG,IAAN,CAAW,SAAX,EAAsBtD,IAAtB,CAA2B,+BAA3B,CAAR,CACA,GAAIqD,CAAC,CAACE,EAAF,CAAK,mBAAL,CAAJ,CAA+B,CAE3BL,CAAM,CAAGG,CACZ,CAHD,IAGO,CAEHH,CAAM,CAAGG,CAAC,CAACrD,IAAF,CAAO,wBAAP,CAAT,CACA,GAAmB,CAAf,EAAAkD,CAAM,CAACjD,MAAX,CAAsB,CAElBiD,CAAM,CAAGG,CAAC,CAACrD,IAAF,CAAO,QAAP,EAAiBwD,QAAjB,GAA4BxD,IAA5B,CAAiC,wBAAjC,CAAT,CACA,GAAmB,CAAf,EAAAkD,CAAM,CAACjD,MAAX,CAAsB,CAElBiD,CAAM,CAAGG,CAAC,CAACrD,IAAF,CAAO,mBAAP,CACZ,CACJ,CACJ,CACJ,CAED,GAAa,IAAT,GAAAkD,CAAM,EAA0B,CAAf,EAAAA,CAAM,CAACjD,MAA5B,CAAuC,CACnC,QACH,CAED,GAA4B,UAAxB,EAAAiD,CAAM,CAACnC,IAAP,CAAY,SAAZ,CAAJ,CAAwC,CACpC8B,CAAM,CAAGK,CAAM,CAACjB,GAAP,EAAT,CACAiB,CAAM,CAACjB,GAAP,CAAWW,CAAX,EAAmB/B,KAAnB,EACH,CAHD,IAGO,CACHgC,CAAM,CAAGK,CAAM,CAACf,IAAP,EAAT,CACAe,CAAM,CAACf,IAAP,CAAYS,CAAZ,EAAoB/B,KAApB,EACH,CAED,GAAIiC,CAAJ,CAAkB,CACdhF,CAAK,CAACS,gBAAN,CAAyBsE,CAC5B,CACD,QACH,CAzDW,EAyDTY,OAzDS,CAyDD,OAzDC,CAAZ,CA0DH,CAvED,CAwEH,CA7ED,CA+EA,MAAO3F,CAAAA,CACV,CAlQK,CAAN","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the term of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * load the Essay (auto-grade) question\n *\n * @module      qtype_essayautograde/view\n * @category    output\n * @copyright   2018 Gordon Bateson (gordon.bateson@gmail.com)\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since       Moodle 3.0\n */\ndefine([\"jquery\", \"core/str\"], function($, STR) {\n\n    /** @alias module:qtype_essayautograde/view */\n    var ESSAY = {};\n\n    // cache the plugin name and string cache\n    ESSAY.plugin = \"qtype_essayautograde\";\n    ESSAY.str = {};\n\n    ESSAY.itemtype = \"\";\n    ESSAY.itemmatch = \"\";\n    ESSAY.editortype = \"\";\n\n    ESSAY.editormaxtries = 50;\n    ESSAY.editorinterval = 100; // 100 ms\n\n    ESSAY.responsesample = \"\";\n    ESSAY.responseoriginal = \"\";\n\n    /*\n     * initialize this AMD module\n     */\n    ESSAY.init = function(readonly, itemtype, editortype, responsesample) {\n\n        // get RegExp expression for this item type\n        var itemmatch = \"\";\n        switch (itemtype) {\n            case \"chars\": itemmatch = \".\"; break;\n            case \"words\": itemmatch = \"\\\\w+\"; break;\n            case \"sentences\": itemmatch = \"[^\\\\.?!]+[\\\\.?!]\"; break;\n            case \"paragraphs\": itemmatch = \"[^\\\\r\\\\n]+[\\\\r\\\\n]*\"; break;\n        }\n        // take a look at https://github.com/RadLikeWhoa/Countable/blob/master/Countable.js\n        // for more ideas on how to count chars, words, sentences, and paragraphs\n\n        ESSAY.itemtype = itemtype;\n        ESSAY.itemmatch = new RegExp(itemmatch, \"g\");\n        ESSAY.editortype = editortype;\n\n        if (readonly) {\n            ESSAY.setup_response_heights();\n        } else {\n            ESSAY.setup_itemcounts();\n            ESSAY.setup_responsesample(responsesample);\n        }\n    };\n\n    ESSAY.setup_response_heights = function() {\n       $(\"textarea.qtype_essay_response\").each(function(){\n           $(this).height(1);\n           $(this).height(this.scrollHeight);\n       });\n    };\n\n    ESSAY.setup_itemcounts = function() {\n        $(\".qtype_essay_response\").each(function(){\n            var id = ESSAY.get_itemcount_id(this);\n            var editorloaded = $.Deferred();\n            ESSAY.check_editor(this, editorloaded);\n            $.when(editorloaded).done($.proxy(function(){\n                ESSAY.create_itemcount(this, id);\n                ESSAY.setup_itemcount(this, id);\n            }, this, id));\n        });\n\n    };\n\n    ESSAY.check_editor = function(response, editorloaded) {\n        var selector = \"\";\n        switch (ESSAY.editortype) {\n            case \"atto\": selector = \"[contenteditable=true]\"; break;\n            case \"tinymce\": selector = \"iframe\"; break;\n        }\n        if (selector==\"\") {\n            // textarea - or unknown !!\n            editorloaded.resolve();\n        } else {\n            var editorchecker = setInterval(function() {\n                if ($(response).find(selector).length) {\n                    clearInterval(editorchecker);\n                    editorloaded.resolve();\n                }\n            }, ESSAY.editorinterval);\n        }\n    };\n\n    ESSAY.create_itemcount = function(response, id) {\n        if (document.getElementById(id)===null) {\n            var p = document.createElement(\"P\");\n            p.setAttribute(\"id\", id);\n            p.setAttribute(\"class\", \"itemcount\");\n            response.parentNode.insertBefore(p, response.nextSibling);\n        }\n    };\n\n    ESSAY.setup_itemcount = function(response, id) {\n        var editable = ESSAY.get_editable_element(response);\n        if (editable) {\n            $(editable).keyup(function(){\n                ESSAY.show_itemcount(this, id);\n            });\n            ESSAY.show_itemcount(editable, id);\n        }\n    };\n\n    ESSAY.get_editable_element = function(response) {\n        // search for plain text editor\n        if ($(response).prop(\"tagName\")==\"TEXTAREA\") {\n            return response;\n        }\n        // search for Atto editor\n        var editable = $(response).find(\"[contenteditable=true]\");\n        if (editable.length) {\n            return editable.get(0);\n        }\n        // search for MCE editor\n        var i = response.getElementsByTagName(\"IFRAME\");\n        if (i.length) {\n            i = i[0];\n            var d = (i.contentWindow || i.contentDocument);\n            if (d.document) {\n                d = d.document;\n            }\n            if (d.body && d.body.isContentEditable) {\n                return d.body;\n            }\n        }\n        // search for disabled text editor\n        var editable = $(response).find(\"textarea\");\n        if (editable.length) {\n            return editable.get(0);\n        }\n        // shouldn't happen !!\n        return null;\n    };\n\n    ESSAY.get_textarea = function(response) {\n        if ($(response).prop(\"tagName\")==\"TEXTAREA\") {\n            return response;\n        }\n        return $(response).find(\"textarea\").get(0);\n    };\n\n    ESSAY.get_textarea_name = function(response) {\n        var textarea = ESSAY.get_textarea(response);\n        return $(textarea).attr(\"name\");\n    };\n\n    ESSAY.get_itemcount_id = function(response) {\n        var name = ESSAY.get_textarea_name(response);\n        return \"id_\" + name + \"_itemcount\";\n    };\n\n    ESSAY.escape = function(id) {\n        var regexp = new RegExp(\"(:|\\\\.|\\\\[|\\\\]|,|=|@)\", \"g\");\n        return \"#\" + id.replace(regexp, \"\\\\$1\");\n    };\n\n    ESSAY.show_itemcount = function(response, id) {\n        if ($(response).prop(\"tagName\")==\"TEXTAREA\") {\n            var itemcount = $(response).val().match(ESSAY.itemmatch);\n        } else {\n            var itemcount = $(response).text().match(ESSAY.itemmatch);\n        }\n        if (itemcount) {\n            itemcount = itemcount.length;\n        } else {\n            itemcount = 0;\n        }\n\n        // fetch descriptor string\n        STR.get_strings([\n            {\"key\": ESSAY.itemtype, \"component\": ESSAY.plugin}\n        ]).done(function(s) {\n            $(ESSAY.escape(id)).text(s[0] + \": \" + itemcount);\n        });\n    };\n\n    ESSAY.setup_responsesample = function(txt) {\n        if (txt=='') {\n            return;\n        }\n        ESSAY.responsesample = txt;\n        STR.get_strings([\n            {\"key\": \"hidesample\", \"component\": ESSAY.plugin},\n            {\"key\": \"showsample\", \"component\": ESSAY.plugin}\n        ]).done(function(s) {\n            ESSAY.str.hidesample = s[0];\n            ESSAY.str.showsample = s[1];\n            var last = $(\".qtext\").find(\"p:not(:empty), div:not(:empty)\");\n            if (last.length) {\n                last = last.last();\n            } else {\n                last = $(\".qtext\");\n            }\n\n            last.append($(\"<span></span>\").click(function(){\n                var newtxt = \"\",\n                    oldtxt = \"\",\n                    saveresponse = false;\n                if ($(this).hasClass(\"showsample\")) {\n                    $(this).removeClass(\"showsample\")\n                           .addClass(\"hidesample\")\n                           .text(ESSAY.str.hidesample);\n                    newtxt = ESSAY.responsesample;\n                    saveresponse = true;\n                } else {\n                    $(this).removeClass(\"hidesample\")\n                           .addClass(\"showsample\")\n                           .text(ESSAY.str.showsample);\n                    newtxt = ESSAY.responseoriginal;\n                }\n\n                // Locate response element\n                var editor = null;\n                var qtext = $(this).closest(\".qtext\");\n                if (ESSAY.editortype==\"audio\" || ESSAY.editortype==\"video\") {\n                    editor = qtext.find(\".audiovideo_response_prompt\");\n                } else {\n                    var r = qtext.next(\".ablock\").find(\".answer .qtype_essay_response\");\n                    if (r.is(\"[name$='_answer']\")) {\n                        // Plain text (i.e. no editor)\n                        editor = r;\n                    } else {\n                        // Atto\n                        editor = r.find(\"[contenteditable=true]\");\n                        if (editor.length==0) {\n                            // TinyMCE\n                            editor = r.find(\"iframe\").contents().find(\"[contenteditable=true]\");\n                            if (editor.length==0) {\n                                // Plain text editor\n                                editor = r.find(\"[name$='_answer']\");\n                            }\n                        }\n                    }\n                }\n\n                if (editor===null || editor.length==0) {\n                    return false; // shouldn't happen !!\n                }\n\n                if (editor.prop(\"tagName\")==\"TEXTAREA\") {\n                    oldtxt = editor.val();\n                    editor.val(newtxt).keyup();\n                } else {\n                    oldtxt = editor.text();\n                    editor.text(newtxt).keyup();\n                }\n\n                if (saveresponse) {\n                    ESSAY.responseoriginal = oldtxt;\n                }\n                return true;\n            }).trigger(\"click\"));\n        });\n    };\n\n    return ESSAY;\n});\n"],"file":"essayautograde.min.js"}