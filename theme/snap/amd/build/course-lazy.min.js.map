{"version":3,"sources":["../src/course-lazy.js"],"names":["define","$","util","sectionAssetManagement","courseModules","courseConfig","self","onCoursePage","attr","indexOf","scrollToModule","modid","html","targmod","replace","scrollToElement","searchpin","length","find","prepend","focus","removeClass","setTOCVisibleSection","currentSectionId","parent","addClass","document","trigger","showSection","sectionSetByServer","urlParams","location","hash","split","section","mod","scrollBack","visibleChapters","on","sessionStorage","setItem","parents","storedmod","getItem","window","scrollTo","removeItem","init","enablecompletion","require","conditionals","modchooserSectionLinks","click","sectionNum","each","newLink","href"],"mappings":"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","sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @package   theme_snap\n * @copyright Copyright (c) 2016 Blackboard Inc. (http://www.blackboard.com)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * Course main functions.\n */\ndefine(\n    [\n        'jquery',\n        'theme_snap/util',\n        'theme_snap/section_asset_management',\n        'theme_snap/course_modules'\n    ],\n    function($, util, sectionAssetManagement, courseModules) {\n\n    /**\n     * Return class(has private and public methods).\n     * @param {object} courseConfig\n     */\n    return function(courseConfig) {\n\n        var self = this;\n\n        self.courseConfig = courseConfig;\n\n        /**\n         * Are we on the main course page - i.e. TOC is visible.\n         * @returns {boolean}\n         */\n        var onCoursePage = function() {\n            return $('body').attr('id').indexOf('page-course-view-') === 0;\n        };\n\n        /**\n         * Scroll to a mod via search\n         * @param {string} modid\n         */\n        var scrollToModule = function(modid) {\n            // sometimes we have a hash, sometimes we don't\n            // strip hash then add just in case\n            $('#toc-search-results').html('');\n            var targmod = $(\"#\" + modid.replace('#', ''));\n            // http://stackoverflow.com/questions/6677035/jquery-scroll-to-element\n            util.scrollToElement(targmod);\n\n            var searchpin = $(\"#searchpin\");\n            if (!searchpin.length) {\n                searchpin = $('<i id=\"searchpin\"></i>');\n            }\n\n            $(targmod).find('.instancename').prepend(searchpin);\n            $(targmod).attr('tabindex', '-1').focus();\n            $('#course-toc').removeClass('state-visible');\n        };\n\n        /**\n         * Mark the section shown to user with a class in the TOC.\n         */\n        this.setTOCVisibleSection = function() {\n            var sectionIdSel = '.section.main.state-visible, #coursetools.state-visible, #snap-add-new-section.state-visible';\n            var currentSectionId = $(sectionIdSel).attr('id');\n            $('#chapters li').removeClass('snap-visible-section');\n            $('#chapters a[href$=\"' + currentSectionId + '\"]').parent('li').addClass('snap-visible-section');\n            $(document).trigger('snapContentRevealed');\n        };\n\n        /**\n         * When on course page, show the section currently referenced in the location hash.\n         */\n        this.showSection = function() {\n            if (!onCoursePage()) {\n                // Only relevant for main course page.\n                return;\n            }\n            var sectionSetByServer = '';\n\n            if ($('.section.main.state-visible.set-by-server').length) {\n                sectionSetByServer = '#' + $('.section.main.state-visible.set-by-server').attr('id');\n                $('.section.main.state-visible.set-by-server').removeClass('set-by-server');\n            } else {\n                $('.course-content .section.main, #moodle-blocks,#coursetools, #snap-add-new-section').removeClass('state-visible');\n            }\n\n            // We know the params at 0 is a section id.\n            // Params will be in the format: #section-[number]&module-[cmid], e.g: #section-1&module-7255.\n            var urlParams = location.hash.split(\"&\"),\n                section = urlParams[0],\n                mod = urlParams[1] || null;\n\n            if (section !== '' && section !== sectionSetByServer) {\n                $(sectionSetByServer).removeClass('state-visible');\n            }\n\n            // Course tools special section.\n            if (section == '#coursetools') {\n                $('#moodle-blocks').addClass('state-visible');\n            }\n\n            // If a modlue was in the hash then scroll to it.\n            if (mod !== null) {\n                $(section).addClass('state-visible');\n                scrollToModule(mod);\n            } else {\n                $(section).addClass('state-visible').focus();\n                // Faux link click behaviour - scroll to page top.\n                scrollBack();\n            }\n\n            // Default niceties to perform.\n            var visibleChapters = $(\n                '.section.main.state-visible,' +\n                '#coursetools.state-visible,' +\n                '#snap-add-new-section.state-visible'\n            );\n            if (!visibleChapters.length) {\n                if ($('.section.main.current').length) {\n                    $('.section.main.current').addClass('state-visible').focus();\n                } else {\n                    $('#section-0').addClass('state-visible').focus();\n                }\n                scrollBack();\n            }\n\n            // Store last activity/resource accessed on sessionStorage\n            $('li.snap-activity:visible, li.snap-resource:visible').on('click', 'a.mod-link', function() {\n                sessionStorage.setItem('lastMod', $(this).parents('[id^=module]').attr('id'));\n            });\n\n            this.setTOCVisibleSection();\n        };\n\n        /**\n         * Scroll to the last activity or resource accessed,\n         * if there is nothing stored in session go to page top.\n         */\n        var scrollBack = function () {\n            var storedmod = sessionStorage.getItem('lastMod');\n            if(storedmod === null){\n                window.scrollTo(0, 0);\n            } else {\n                util.scrollToElement($('#'+storedmod+''));\n                sessionStorage.removeItem('lastMod');\n            }\n        };\n\n        /**\n         * Initialise course JS.\n         */\n        var init = function() {\n            sectionAssetManagement.init(self);\n            courseModules.init();\n\n            // Only load the conditionals library if it's enabled for the course, viva la HTTP2!\n            if (self.courseConfig.enablecompletion) {\n                require(\n                    [\n                        'theme_snap/course_conditionals-lazy'\n                    ], function(conditionals) {\n                        conditionals(courseConfig);\n                    }\n                );\n            }\n\n            // SL - 19th aug 2014 - check we are in a course and if so, show current section.\n            if (onCoursePage()) {\n                self.showSection();\n                $(document).on('snapTOCReplaced', function() {\n                    self.setTOCVisibleSection();\n                });\n            }\n        };\n\n        /**\n         * Snap modchooser listener to add current section to urls.\n         */\n        var modchooserSectionLinks = function() {\n            $('.section-modchooser-link').click(function() {\n                // Grab the section number from the button.\n                var sectionNum = $(this).attr('data-section');\n                $('.snap-modchooser-addlink').each(function() {\n                    // Update section in mod link to current section.\n                    var newLink = this.href.replace(/(section=)[0-9]+/ig, '$1' + sectionNum);\n                    $(this).attr('href', newLink);\n                });\n            });\n        };\n\n        // Intialise course lib.\n        init();\n        modchooserSectionLinks();\n    };\n});\n"],"file":"course-lazy.min.js"}