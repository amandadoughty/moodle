{"version":3,"sources":["../src/personal_menu.js"],"names":["define","$","log","Y","courseCards","util","ajaxNotify","PersonalMenu","self","redirectToSitePolicy","update","redirect","M","cfg","wwwroot","window","location","reqCourseInfo","getCourseIds","focus","loadAjaxInfo","type","container","length","cacheKey","sesskey","supportsSessionStorage","sessionStorage","info","html","ajax","async","url","context","success","data","ifErrorShowBestMsg","done","errorShown","attr","err","clear","error","document","trigger","mobilePersonalMenuListeners","getSectionCoords","href","sections","sectionWidth","outerWidth","section","targetSection","index","position","sectionHeight","outerHeight","winHeight","height","left","on","innerWidth","removeAttr","activeLink","posHeight","css","e","getAttribute","animate","scrollTop","removeClass","addClass","preventDefault","applyListeners","event","toggleClass","is","init","sitePolicyAcceptReqd"],"mappings":"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","sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @package   theme_snap\n * @copyright Copyright (c) 2016 Blackboard Inc. (http://www.blackboard.com)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * Snap Personal menu.\n */\ndefine(['jquery', 'core/log', 'core/yui', 'theme_snap/pm_course_cards', 'theme_snap/util', 'theme_snap/ajax_notification'],\n    function($, log, Y, courseCards, util, ajaxNotify) {\n\n        /**\n         * Personal Menu (courses menu).\n         * @constructor\n         */\n        var PersonalMenu = function() {\n\n            var self = this;\n\n            var redirectToSitePolicy = false;\n\n            /**\n             * Add deadlines, messages, grades & grading,  async'ly to the personal menu\n             *\n             */\n            this.update = function() {\n\n                // If site policy needs acceptance, then don't update, just redirect to site policy!\n                if (redirectToSitePolicy) {\n                    var redirect = M.cfg.wwwroot + '/user/policy.php';\n                    window.location = redirect;\n                    return;\n                }\n\n                // Update course cards with info.\n                courseCards.reqCourseInfo(courseCards.getCourseIds());\n\n\n                $('#snap-pm').focus();\n\n                /**\n                 * Load ajax info into personal menu.\n                 * @param {string} type\n                 */\n                var loadAjaxInfo = function(type) {\n                    // Target for data to be displayed on screen.\n                    var container = $('#snap-personal-menu-' + type);\n                    if ($(container).length) {\n                        var cacheKey = M.cfg.sesskey + 'personal-menu-' + type;\n                        try {\n                            // Display old content while waiting\n                            if (util.supportsSessionStorage() && window.sessionStorage[cacheKey]) {\n                                log.info('using locally stored ' + type);\n                                var html = window.sessionStorage[cacheKey];\n                                $(container).html(html);\n                            }\n                            log.info('fetching ' + type);\n                            $.ajax({\n                                type: \"GET\",\n                                async: true,\n                                url: M.cfg.wwwroot + '/theme/snap/rest.php?action=get_' + type + '&contextid=' + M.cfg.context,\n                                success: function(data) {\n                                    ajaxNotify.ifErrorShowBestMsg(data).done(function(errorShown) {\n                                        if (errorShown) {\n                                            return;\n                                        } else {\n                                            // No errors, update sesion storage.\n                                            log.info('fetched ' + type);\n                                            if (util.supportsSessionStorage() && typeof (data.html) != 'undefined') {\n                                                window.sessionStorage[cacheKey] = data.html;\n                                            }\n                                            // Note: we can't use .data because that does not manipulate the dom, we need the data\n                                            // attribute populated immediately so things like behat can utilise it.\n                                            // .data just sets the value in memory, not the dom.\n                                            $(container).attr('data-content-loaded', '1');\n                                            $(container).html(data.html);\n                                        }\n                                    });\n                                }\n                            });\n                        } catch (err) {\n                            sessionStorage.clear();\n                            log.error(err);\n                        }\n                    }\n                };\n\n                loadAjaxInfo('deadlines');\n                loadAjaxInfo('graded');\n                loadAjaxInfo('grading');\n                loadAjaxInfo('messages');\n                loadAjaxInfo('forumposts');\n\n                $(document).trigger('snapUpdatePersonalMenu');\n            };\n\n            /**\n             * Apply listeners for personal menu in mobile mode.\n             */\n            var mobilePersonalMenuListeners = function() {\n                /**\n                 * Get section left position and height.\n                 * @param {string} href\n                 * @returns {Object.<string, number>}\n                 */\n                var getSectionCoords = function(href) {\n                    var sections = $(\"#snap-pm-content section\");\n                    var sectionWidth = $(sections).outerWidth();\n                    var section = $(href);\n                    var targetSection = $(\"#snap-pm-updates section > div\").index(section) + 1;\n                    var position = sectionWidth * targetSection;\n                    var sectionHeight = $(href).outerHeight() + 200;\n\n                    // Course lists is at position 0.\n                    if (href == '#snap-pm-courses') {\n                        position = 0;\n                    }\n\n                    // Set the window height.\n                    var winHeight = $(window).height();\n                    if (sectionHeight < winHeight) {\n                        sectionHeight = winHeight;\n                    }\n                    return {left: position, height: sectionHeight};\n                };\n                // Personal menu small screen behaviour corrections on resize.\n                $(window).on('resize', function() {\n                    if (window.innerWidth >= 992) {\n                        // If equal or larger than Bootstrap 992 large breakpoint, clear left positions of sections.\n                        $('#snap-pm-content').removeAttr('style');\n                        return;\n                    }\n                    var activeLink = $('#snap-pm-mobilemenu a.state-active');\n                    if (!activeLink || !activeLink.length) {\n                        return;\n                    }\n                    var href = activeLink.attr('href');\n                    var posHeight = getSectionCoords(href);\n\n                    $('#snap-pm-content').css('left', '-' + posHeight.left + 'px');\n                    $('#snap-pm-content').css('height', posHeight.height + 'px');\n                });\n                // Personal menu small screen behaviour.\n                $(document).on(\"click\", '#snap-pm-mobilemenu a', function(e) {\n                    var href = this.getAttribute('href');\n                    var posHeight = getSectionCoords(href);\n\n                    $(\"html, body\").animate({scrollTop: 0}, 0);\n                    $('#snap-pm-content').animate({\n                            left: '-' + posHeight.left + 'px',\n                            height: posHeight.height + 'px'\n                        }, \"700\", \"swing\",\n                        function() {\n                            // Animation complete.\n                        });\n                    $('#snap-pm-mobilemenu a').removeClass('state-active');\n                    $(this).addClass('state-active');\n                    e.preventDefault();\n                });\n            };\n\n            /**\n             * Apply personal menu listeners.\n             */\n            var applyListeners = function() {\n                // On clicking personal menu trigger.\n                $(document).on(\"click\", \".js-snap-pm-trigger\", function(event) {\n                    $(\"html, body\").animate({scrollTop: 0}, 0);\n                    $('body').toggleClass('snap-pm-open');\n                    if ($('.snap-pm-open #snap-pm').is(':visible')) {\n                        self.update();\n                    }\n                    event.preventDefault();\n                });\n\n                mobilePersonalMenuListeners();\n            };\n\n            /**\n             * Initialising function.\n             * @param {boolean} sitePolicyAcceptReqd\n             */\n            this.init = function(sitePolicyAcceptReqd) {\n                redirectToSitePolicy = sitePolicyAcceptReqd;\n                applyListeners();\n                if (!redirectToSitePolicy) {\n                    courseCards.init();\n                }\n            };\n        };\n\n        return new PersonalMenu();\n    }\n);\n"],"file":"personal_menu.min.js"}