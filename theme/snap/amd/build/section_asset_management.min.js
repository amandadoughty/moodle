define ("theme_snap/section_asset_management",["jquery","core/log","core/ajax","core/str","core/templates","core/notification","theme_snap/util","theme_snap/ajax_notification","theme_snap/footer_alert"],function(a,b,c,d,e,f,g,h,i){return{init:function init(j){var k=[],l,m=!1,n;n=new function AjaxTracker(){var c={};this.start=function(d,e,f){if(this.ajaxing(d)){b.debug("Skipping ajax request for "+d+", AJAX already in progress");return!1}M.util.js_pending(d);c[d]={trigger:e,subSelector:f};if(e){if(f){a(e).find(f).addClass("ajaxing")}else{a(e).addClass("ajaxing")}}return!0};this.ajaxing=function(a){return-1<M.util.pending_js.indexOf(a)};this.complete=function(b){var d,e;if(c[b]){d=c[b].trigger;e=c[b].subSelector}if(d){if(e){a(d).find(e).removeClass("ajaxing")}else{a(d).removeClass("ajaxing")}}delete c[b];M.util.js_complete(b)}};var o=function(b){return parseInt(a(b).attr("id").replace("section-",""))},p=function(b){return o(a(b).parents("li.section.main")[0])},q=function(){a("body").removeClass("snap-move-inprogress");a("body").removeClass("snap-move-section");a("body").removeClass("snap-move-asset");i.hideAndReset();a(".section-moving").removeClass("section-moving");a(".asset-moving").removeClass("asset-moving");a(".snap-asset a").removeAttr("tabindex");a(".snap-asset button").removeAttr("disabled");a(".js-snap-asset-move").removeAttr("checked");k=[]},r=function(){var b=a(l).find(".instancename").html();i.removeAjaxLoading();i.setTitle(M.util.get_string("movefailed","theme_snap",b));window.setTimeout(function(){q(!1)},2e3)},s=function(){var b;if(1===k.length){var c=a(k[0]).find(".snap-asset-link .instancename").html();c=c||M.util.get_string("pluginname","label",c);b=M.util.get_string("moving","theme_snap",c)}else{b=M.util.get_string("movingcount","theme_snap",k.length)}i.setTitle(b)},t=function(a){var b=k.indexOf(a);if(-1<b){k.splice(b,1)}s()},u=function(c,d,e){if(m){b.debug("Skipping ajax request, one already in progress");return}i.addAjaxLoading();c.sesskey=M.cfg.sesskey;c.courseId=j.courseConfig.id;c.field="move";b.debug("Making course/rest.php request",c);var f=a.ajax({type:"POST",async:!0,data:c,url:M.cfg.wwwroot+j.courseConfig.ajaxurl});f.done(function(a){h.ifErrorShowBestMsg(a).done(function(a){if(a){b.debug("Ajax request fail");r()}else{b.debug("Ajax request successful");if(d){d()}if(e){if("resource"===c.class){q()}}}})});f.fail(function(){r()});if(e){f.always(function(){m=!1;i.removeAjaxLoading()})}},v=function(b){return a("#chapters li:nth-of-type("+(b+1)+") .chapter-title").html()},w=function(b){var c=a.Deferred(),d,f;if(!b){b="#region-main .course-content > ul li.section";d=a(b);f=d.length}else{d=a(b);var g=a("#region-main .course-content > ul li.section");f=g.length}var h=0;a.each(d,function(b,g){var i=o(g),j=i-1,k=i+1,l=!1,m=!1,n,p;if(-1<j){n=a("#section-"+j).hasClass("hidden");p=n?" dimmed_text":"";l={section:j,title:v(j),classes:p}}if(k<f){n=a("#section-"+k).hasClass("hidden");p=n?" dimmed_text":"";m={section:k,title:v(k),classes:p}}var q={previous:l,next:m};e.render("theme_snap/course_section_navigation",q).done(function(b){a("#section-"+i+" .section_footer").replaceWith(b);h++;if(h===d.length){c.resolve()}})});return c.promise()},x=function(){a.each(a("#region-main .course-content > ul li.section"),function(b,c){a(c).attr("id","section-"+b);var d=v(b);a("#section-"+b+" .content .sectionname").html(d);a(this).find("a.section-modchooser-link").attr("data-section",b)});w()},y=function(d,g){d.preventDefault();var k=p(g),l=a("#section-"+k),m=l.find(".sectionname").text(),o=function(){if(!n.start("section_delete",g)){return}var d=M.util.get_string("deletingsection","theme_snap",m);i.setTitle(d);i.addAjaxLoading("");i.show();var f={courseshortname:j.courseConfig.shortname,action:"delete",sectionnumber:k,value:1};b.debug("Making course/rest.php section delete request",f);var o=c.call([{methodname:"theme_snap_course_sections",args:f}],!0,!0);o[0].done(function(b){e.render("theme_snap/course_toc",b.toc).done(function(b){a("#course-toc").html(a(b).html());a(document).trigger("snapTOCReplaced");l.remove();x();if(k>=a(".course-content > ul li.section").length){location.hash="section-"+(k-1)}j.showSection();n.complete("section_delete")}).always(function(){i.hideAndReset()}).fail(function(){n.complete("section_delete")})}).fail(function(a){h.ifErrorShowBestMsg(a);i.hideAndReset();n.complete("section_delete")})},q=M.util.get_string("confirm","moodle"),r=M.util.get_string("confirmdeletesection","moodle",m),s=M.util.get_string("deletesectionconfirm","theme_snap"),t=M.util.get_string("cancel","moodle");f.confirm(q,r,s,t,o)},z=function(g,e){g.preventDefault();var j=a(a(e).parents(".snap-asset")[0]),k=+j[0].id.replace("module-",""),l=j.find(".instancename").text().trim(),m=a(e).data("action"),o="",p="",q="",r="",s="asset_"+m;if(n.ajaxing(s)){return}var t=function(){if(!n.start(s,j,".snap-edit-asset-more")){return}c.call([{methodname:"core_course_edit_module",args:{action:m,sectionreturn:0,id:k}}],!0,!0)[0].done(function(c){h.ifErrorShowBestMsg(c,q,r).done(function(d){n.complete(s);if(d){b.debug("Ajax request fail")}else{b.debug("Ajax request successful");if("delete"===m){j.remove();a("#toc-searchables li[data-id=\""+k+"\"]").remove()}else if("show"===m){j.removeClass("draft")}else if("hide"===m){j.addClass("draft")}else if("duplicate"===m){j.replaceWith(c)}}})}).fail(function(a){h.ifErrorShowBestMsg(a,q,r).done(function(){n.complete(s)})}).always(function(){i.hideAndReset()})},u=function(){if("duplicate"===m){o="action:duplicateasset";p="error:failedtoduplicateasset"}else if("show"===m||"hide"===m){o="action:changeassetvisibility";p="error:failedtochangeassetvisibility"}else if("delete"===m){o="action:deleteasset";p="error:failedtodeleteasset"}return d.get_strings([{key:o,component:"theme_snap"},{key:p,component:"theme_snap"}])};u().then(function(a){q=a[0];r=a[0];if("delete"===m){var b="",c={type:M.util.get_string("pluginname",j.attr("class").match(/modtype_([^\s]*)/)[1])};if(""!==l){c.name=l;b=M.util.get_string("deletechecktypename","moodle",c)}else{b=M.util.get_string("deletechecktype","moodle",c)}var d=M.util.get_string("confirm","moodle"),e=M.util.get_string("deleteassetconfirm","theme_snap",c.type),g=M.util.get_string("cancel","moodle");f.confirm(d,b,e,g,t)}else{t()}})},A=function(c){var d={};b.debug("Move objects",k);d.class="resource";s();l=k.shift();d.id=+l.id.replace("module-","");if(c&&!a(c).hasClass("snap-drop")){d.beforeId=+a(c)[0].id.replace("module-","")}else{d.beforeId=0}if("page-site-index"===document.body.id){d.sectionId=1}else{if(c){d.sectionId=p(c)}else{d.sectionId=p(l)}}if(0<k.length){u(d,function(){a(c).before(a(l));A(c)},!1)}else{u(d,function(){a(c).before(a(l))},!0)}},B=function(b){var d=p(b),f=o(k[0]),g=f<d?d-1:d;u({class:"section",id:f,value:g},function(){c.call([{methodname:"theme_snap_course_toc_chapters",args:{courseshortname:j.courseConfig.shortname},done:function done(b){e.render("theme_snap/course_toc_chapters",b.chapters).done(function(b){a("#chapters").replaceWith(b);a("#section-"+d).before(a("#section-"+f));x();location.hash="section-"+g;j.showSection();q()})},fail:function fail(a){h.ifErrorShowBestMsg(a);q()}}],!0,!0)},!0)},C=function(){var b=".snap-asset-actions .js_snap_hide, ";b+=".snap-asset-actions .js_snap_show, ";b+=".snap-asset-actions .js_snap_delete, ";b+=".snap-asset-actions .js_snap_duplicate";a(document).on("click",b,function(a){z(a,this)})},D=function(b,d){a("#region-main").on("click",".snap-section-editing.actions .snap-"+b,function(f){f.stopPropagation();f.preventDefault();var g=this,i=function(a){this.message="Invalid section action: "+a;this.name="invalidActionException"};if(-1===["visibility","highlight"].indexOf(b)){throw new i(b)}if(!n.start("section_"+b,g)){return}var k;if("visibility"===b){k=a(this).hasClass("snap-hide")?0:1}else{k="true"===a(this).attr("aria-pressed")?0:1}var l=p(this),m="#section-"+l+" .snap-section-editing"+" .snap-"+b,o=c.call([{methodname:"theme_snap_course_sections",args:{courseshortname:j.courseConfig.shortname,action:b,sectionnumber:l,value:k}}],!0,!0);o[0].fail(function(a){var c,d;if("visibility"===b){c=M.util.get_string("error:failedtochangesectionvisibility","theme_snap");d=M.util.get_string("action:changesectionvisibility","theme_snap")}else{c=M.util.get_string("error:failedtohighlightsection","theme_snap");d=M.util.get_string("action:highlightsectionvisibility","theme_snap")}h.ifErrorShowBestMsg(a,d,c).done(function(){n.complete("section_"+b)})}).always(function(){a(g).removeClass("ajaxing")}).done(function(c){return e.render("theme_snap/course_action_section",c.actionmodel).then(function(b){a(m).replaceWith(b);a(m).focus();return e.render("theme_snap/course_toc",c.toc)}).then(function(c){a("#course-toc").html(a(c).html());a(document).trigger("snapTOCReplaced");if(d&&"function"==typeof d){var e=d(l,k);if(e&&"function"==typeof e.always){e.always(function(){n.complete("section_"+b)})}else{n.complete("section_"+b)}}else{n.complete("section_"+b)}})})})},E=function(){D("highlight",function(b){a("#section-"+b).toggleClass("current");var c=a("li.section.main").not("#section-"+b).not("#section-0").removeClass("current");c.each(function(){var b=a(this).find(".snap-highlight"),c=p(b),d=a(b).attr("href").replace(/(marker=)[0-9]+/ig,"$1"+c);a(b).attr("href",d).attr("aria-pressed","false")})})},F=function(){a(document).on("click",".snap-section-editing.actions .snap-delete",function(a){y(a,this)})},G=function(){D("visibility",function manageHiddenClass(b,c){if(0===c){a("#section-"+b).addClass("hidden")}else{a("#section-"+b).removeClass("hidden")}var d=["#section-"+(b-1),"#section-"+(b+1)].join(",");return w(d)})},H=function(){i.show(function(a){a.preventDefault();q()})},I=function(){a("#region-main").on("click",".snap-section-editing.actions .snap-move",function(c){c.stopPropagation();c.preventDefault();a("body").addClass("snap-move-inprogress");H();var d=p(this);b.debug("Section is",d);var e=a("#section-"+d),f=e.find(".sectionname").text();b.debug("Moving this section",f);k=[e];a(".section-moving").removeClass("section-moving");e.addClass("section-moving");a("a[href=\"#section-"+d+"\"]").parent("li").addClass("section-moving");a("body").addClass("snap-move-section");var g=M.util.get_string("moving","theme_snap",f);i.setTitle(g);a(".section-drop").each(function(){var b=M.util.get_string("movingdropsectionhelp","theme_snap",{moving:f,before:a(this).data("title")});a(this).html(b)});i.setSrNotice(M.util.get_string("movingstartedhelp","theme_snap",f))})},J=function(){if("page-site-index"===document.body.id){a("#region-main .sitetopic ul.section").append("<li class=\"snap-drop asset-drop\"><div class=\"asset-wrapper\"><a href=\"#\">"+M.util.get_string("movehere","theme_snap")+"</a></div></li>")}else{a("li.section .content ul.section").append("<li class=\"snap-drop asset-drop\"><div class=\"asset-wrapper\"><a href=\"#\">"+M.util.get_string("movehere","theme_snap")+"</a></div></li>")}},K=function(){a("#region-main").on("change",".js-snap-asset-move",function(c){c.stopPropagation();var d=a(this).parents(".snap-asset")[0],e=a(d).parents("ul.section")[0],f=a(e).find("li.snap-drop.asset-drop");a(e).append(f);if(0===k.length){var g=a(d).find(".snap-asset-link .instancename").html();b.debug("Moving this asset",g);var h=a(d).attr("class"),i=/(?=snap-mime)([a-z0-9\-]*)/,j=i.exec(h);h="";if(j){h=j.join(" ")}b.debug("Moving this class",h);a(d).addClass("asset-moving");a(".snap-asset button").attr("disabled","disabled");a(d).find("button").removeAttr("disabled");a(".snap-asset .snap-asset-content a").attr("tabindex","-1");a(d).find("a").removeAttr("tabindex");a(d).find(".js-snap-asset-move").prop("checked","checked");a("body").addClass("snap-move-inprogress");a("body").addClass("snap-move-asset")}if(a(this).prop("checked")){k.push(d);a(d).find("a").removeAttr("tabindex");a(d).find("button").removeAttr("disabled");a(d).addClass("asset-moving")}else{t(d);a(d).find(".snap-asset-content a").attr("tabindex","-1");a(d).find("button").attr("disabled","disabled");a(d).removeClass("asset-moving");if(0===k.length){q()}}H();s()})},L=function(){a(document).on("click",".snap-move-note, .snap-drop",function(c){b.debug("Snap drop clicked",c);if(k){c.stopPropagation();c.preventDefault();if(a("body").hasClass("snap-move-section")){B(this)}else{var d;if(a(this).hasClass("snap-drop")){d=this}else{d=a(this).closest(".snap-asset")}A(d)}}})},N=function(){I();G();E();F();K();L();C();J();a("body").addClass("snap-course-listening")},O=function(){if(M.course&&M.course.resource_toolbox){M.course.resource_toolbox.handle_resource_dim=function(a,b,c){return"hide"===c?0:1}}};(function initialise(){N();g.whenTrue(function(){return M.course&&M.course.init_section_toolbox},function(){O()},!0)})()}}});
//# sourceMappingURL=section_asset_management.min.js.map
