{"version":3,"sources":["../src/section_asset_management.js"],"names":["define","$","log","ajax","str","templates","notification","util","ajaxNotify","footerAlert","init","courseLib","movingObjects","movingObject","ajaxing","ajaxTracker","AjaxTracker","triggersByKey","start","jsPendingKey","trigger","subSelector","debug","M","js_pending","find","addClass","pending_js","indexOf","complete","removeClass","js_complete","sectionNumber","el","parseInt","attr","replace","parentSectionNumber","parents","stopMoving","hideAndReset","removeAttr","moveFailed","actname","html","removeAjaxLoading","setTitle","get_string","window","setTimeout","updateMovingMessage","title","length","assetname","removeMovingObject","obj","index","splice","ajaxReqMoveGeneral","params","onSuccess","finalItem","addAjaxLoading","sesskey","cfg","courseId","courseConfig","id","field","req","type","async","data","url","wwwroot","ajaxurl","done","ifErrorShowBestMsg","errorShown","class","fail","always","getSectionTitle","section","updateSectionNavigation","selector","dfd","Deferred","sections","totalSectionCount","allSections","completed","each","idx","sectionNum","previousSection","nextSection","previous","next","hidden","extraclasses","hasClass","classes","navigation","render","result","replaceWith","resolve","promise","updateSections","chapterTitle","sectionDelete","e","preventDefault","sectionName","text","doDelete","delProgress","show","courseshortname","shortname","action","sectionnumber","value","ajaxPromises","call","methodname","args","response","toc","document","remove","location","hash","showSection","delTitle","delConf","ok","cancel","confirm","assetAction","triggerEl","assetEl","cmid","instanceName","trim","errActionKey","errMessageKey","errAction","errMessage","actionAJAX","getErrorStrings","get_strings","key","component","then","strings","plugindata","match","name","ajaxReqMoveAsset","target","shift","beforeId","body","sectionId","before","ajaxReqMoveSection","dropzone","domTargetSection","currentSection","targetSection","chapters","assetEditListeners","actionSelectors","on","sectionActionListener","onComplete","stopPropagation","InvalidActionException","message","toggle","actionSelector","actionmodel","focus","completion","highlightSectionListener","toggleClass","$notCurrent","not","highlighter","newLink","deleteSectionListener","toggleSectionListener","manageHiddenClass","join","footerAlertShowMove","moveSectionListener","parent","sectionDropMsg","moving","setSrNotice","addAfterDrops","append","assetMoveListener","asset","afterdrop","regex","assetclasses","exec","prop","push","movePlaceListener","closest","addListeners","overrideCore","course","resource_toolbox","handle_resource_dim","button","activity","initialise","whenTrue","init_section_toolbox"],"mappings":"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","sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @package   theme_snap\n * @copyright Copyright (c) 2015 Blackboard Inc. (http://www.blackboard.com)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/log', 'core/ajax', 'core/str', 'core/templates', 'core/notification',\n    'theme_snap/util', 'theme_snap/ajax_notification', 'theme_snap/footer_alert'],\n    function($, log, ajax, str, templates, notification, util, ajaxNotify, footerAlert) {\n\n    return {\n        init: function(courseLib) {\n\n            /**\n             * Items being moved - actual dom elements.\n             * @type {array}\n             */\n            var movingObjects = [];\n\n            /**\n             * Item being moved - actual dom element.\n             * @type {object}\n             */\n            var movingObject;\n\n            /**\n             * @type {boolean}\n             */\n            var ajaxing = false;\n\n            var ajaxTracker;\n\n            /**\n             * AJAX tracker class - for tracking chained AJAX requests (prevents behat intermittent faults).\n             * Also, sets and unsets ajax classes on trigger element / child of trigger if specified.\n             */\n            var AjaxTracker = function() {\n\n                var triggersByKey = {};\n\n                /**\n                 * Starts tracking.\n                 * @param {string} jsPendingKey\n                 * @param {domElement} trigger\n                 * @param {string} subSelector\n                 * @returns {boolean}\n                 */\n                this.start = function(jsPendingKey, trigger, subSelector) {\n                    if (this.ajaxing(jsPendingKey)) {\n                        log.debug('Skipping ajax request for ' + jsPendingKey + ', AJAX already in progress');\n                        return false;\n                    }\n                    M.util.js_pending(jsPendingKey);\n                    triggersByKey[jsPendingKey] = {trigger: trigger, subSelector: subSelector};\n                    if (trigger) {\n                        if (subSelector) {\n                            $(trigger).find(subSelector).addClass('ajaxing');\n                        } else {\n                            $(trigger).addClass('ajaxing');\n                        }\n                    }\n                    return true;\n                };\n\n                /**\n                 * Is there an AJAX request in progress.\n                 * @param {string} jsPendingKey\n                 * @returns {boolean}\n                 */\n                this.ajaxing = function(jsPendingKey) {\n                    return M.util.pending_js.indexOf(jsPendingKey) > -1;\n                };\n\n                /**\n                 * Completes tracking.\n                 * @param {string} jsPendingKey\n                 */\n                this.complete = function(jsPendingKey) {\n                    var trigger, subSelector;\n                    if (triggersByKey[jsPendingKey]) {\n                        trigger = triggersByKey[jsPendingKey].trigger;\n                        subSelector = triggersByKey[jsPendingKey].subSelector;\n                    }\n                    if (trigger) {\n                        if (subSelector) {\n                            $(trigger).find(subSelector).removeClass('ajaxing');\n                        } else {\n                            $(trigger).removeClass('ajaxing');\n                        }\n                    }\n                    delete triggersByKey[jsPendingKey];\n                    M.util.js_complete(jsPendingKey);\n                };\n            };\n\n            ajaxTracker = new AjaxTracker();\n\n            /**\n             * Get the section number from a section element.\n             * @param {jQuery|object} el\n             * @returns {number}\n             */\n            var sectionNumber = function(el) {\n                return (parseInt($(el).attr('id').replace('section-', '')));\n            };\n\n            /**\n             * Get the section number for an element within a section.\n             * @param {object} el\n             * @returns {number}\n             */\n            var parentSectionNumber = function(el) {\n                return sectionNumber($(el).parents('li.section.main')[0]);\n            };\n\n            /**\n             * Moving has stopped, clean up.\n             */\n            var stopMoving = function() {\n                $('body').removeClass('snap-move-inprogress');\n                $('body').removeClass('snap-move-section');\n                $('body').removeClass('snap-move-asset');\n                footerAlert.hideAndReset();\n                $('.section-moving').removeClass('section-moving');\n                $('.asset-moving').removeClass('asset-moving');\n                $('.snap-asset a').removeAttr('tabindex');\n                $('.snap-asset button').removeAttr('disabled');\n                $('.js-snap-asset-move').removeAttr('checked');\n                movingObjects = [];\n            };\n\n            /**\n             * Move fail - sad face :(.\n             */\n            var moveFailed = function() {\n                var actname = $(movingObject).find('.instancename').html();\n\n                footerAlert.removeAjaxLoading();\n                footerAlert.setTitle(M.util.get_string('movefailed', 'theme_snap', actname));\n                // Stop moving in 2 seconds so that the user has time to see the failed moving notice.\n                window.setTimeout(function() {\n                    // Don't pass in target, we want to abort the move!\n                    stopMoving(false);\n                }, 2000);\n            };\n\n            /**\n             * Update moving message.\n             */\n            var updateMovingMessage = function() {\n                var title;\n                if (movingObjects.length === 1) {\n                    var assetname = $(movingObjects[0]).find('.snap-asset-link .instancename').html();\n                    assetname = assetname || M.util.get_string('pluginname', 'label', assetname);\n                    title = M.util.get_string('moving', 'theme_snap', assetname);\n                } else {\n                    title = M.util.get_string('movingcount', 'theme_snap', movingObjects.length);\n                }\n                footerAlert.setTitle(title);\n            };\n\n            /**\n             * Remove moving object from moving objects array.\n             * @param {object} obj\n             */\n            var removeMovingObject = function(obj) {\n                var index = movingObjects.indexOf(obj);\n                if (index > -1) {\n                    movingObjects.splice(index, 1);\n                }\n                updateMovingMessage();\n            };\n\n            /**\n             * General move request\n             *\n             * @param {object}   params\n             * @param {function} onSuccess\n             * @param {bool}     finalItem\n             */\n            var ajaxReqMoveGeneral = function(params, onSuccess, finalItem) {\n                if (ajaxing) {\n                    // Request already made.\n                    log.debug('Skipping ajax request, one already in progress');\n                    return;\n                }\n\n                // Add spinner.\n                footerAlert.addAjaxLoading();\n\n                // Set common params.\n                params.sesskey = M.cfg.sesskey;\n                params.courseId = courseLib.courseConfig.id;\n                params.field = 'move';\n\n                log.debug('Making course/rest.php request', params);\n                var req = $.ajax({\n                    type: \"POST\",\n                    async: true,\n                    data: params,\n                    url: M.cfg.wwwroot + courseLib.courseConfig.ajaxurl\n                });\n                req.done(function(data) {\n                    ajaxNotify.ifErrorShowBestMsg(data).done(function(errorShown) {\n                        if (errorShown) {\n                            log.debug('Ajax request fail');\n                            moveFailed();\n                            return;\n                        } else {\n                            // No errors, call success callback and stop moving if necessary.\n                            log.debug('Ajax request successful');\n                            if (onSuccess) {\n                                onSuccess();\n                            }\n                            if (finalItem) {\n                                if (params.class === 'resource') {\n                                    // Only stop moving for resources, sections handle this later once the TOC is reloaded.\n                                    stopMoving();\n                                }\n                            }\n                        }\n                    });\n                });\n                req.fail(function() {\n                    moveFailed();\n                });\n\n                if (finalItem) {\n                    req.always(function() {\n                        ajaxing = false;\n                        footerAlert.removeAjaxLoading();\n                    });\n                }\n            };\n\n            /**\n             * Get section title.\n             * @param {integer} section\n             * @returns {*|jQuery}\n             */\n            var getSectionTitle = function(section) {\n                // Get title from TOC.\n                return $('#chapters li:nth-of-type(' + (section + 1) + ') .chapter-title').html();\n            };\n\n            /**\n             * Update next / previous links.\n             * @param {string} selector\n             * @return {promise}\n             */\n            var updateSectionNavigation = function(selector) {\n                var dfd = $.Deferred();\n                var sections, totalSectionCount;\n                if (!selector) {\n                    selector = '#region-main .course-content > ul li.section';\n                    sections = $(selector);\n                    totalSectionCount = sections.length;\n                } else {\n                    sections = $(selector);\n                    var allSections = $('#region-main .course-content > ul li.section');\n                    totalSectionCount = allSections.length;\n                }\n\n                var completed = 0;\n\n                $.each(sections, function(idx, el) {\n                    var sectionNum = sectionNumber(el);\n                    var previousSection = sectionNum - 1;\n                    var nextSection = sectionNum + 1;\n                    var previous = false;\n                    var next = false;\n                    var hidden, extraclasses;\n                    if (previousSection > -1) {\n                        hidden = $('#section-' + previousSection).hasClass('hidden');\n                        extraclasses = hidden ? ' dimmed_text' : '';\n                        previous = {\n                            section: previousSection,\n                            title: getSectionTitle(previousSection),\n                            classes: extraclasses\n                        };\n                    }\n                    if (nextSection < totalSectionCount) {\n                        hidden = $('#section-' + nextSection).hasClass('hidden');\n                        extraclasses = hidden ? ' dimmed_text' : '';\n                        next = {\n                            section: nextSection,\n                            title: getSectionTitle(nextSection),\n                            classes: extraclasses\n                        };\n                    }\n                    var navigation = {\n                        previous: previous,\n                        next: next\n                    };\n                    templates.render('theme_snap/course_section_navigation', navigation)\n                        .done(function(result) {\n                            $('#section-' + sectionNum + ' .section_footer').replaceWith(result);\n                            completed++;\n                            if (completed === sections.length) {\n                                dfd.resolve();\n                            }\n                        });\n\n                });\n                return dfd.promise();\n            };\n\n            /**\n             * Update sections.\n             */\n            var updateSections = function() {\n\n                // Renumber section ids, rename section titles.\n                $.each($('#region-main .course-content > ul li.section'), function(idx, obj) {\n                    $(obj).attr('id', 'section-' + idx);\n                    // Get title from TOC (note that its idx + 1 because first entry is\n                    // introduction.\n                    var chapterTitle = getSectionTitle(idx);\n                    // Update section title with corresponding TOC title - this is necessary\n                    // for weekly topic courses where the section title needs to stay the\n                    // same as the TOC.\n                    $('#section-' + idx + ' .content .sectionname').html(chapterTitle);\n                    // Update section data attribute to reflect new section idx.\n                    $(this).find('a.section-modchooser-link').attr('data-section', idx);\n                });\n\n                updateSectionNavigation();\n            };\n\n            /**\n             * Delete section dialog and confirm function.\n             * @param {object} e\n             * @param {object} el\n             */\n            var sectionDelete = function(e, el) {\n                e.preventDefault();\n                var sectionNum = parentSectionNumber(el);\n                var section = $('#section-' + sectionNum);\n                var sectionName = section.find('.sectionname').text();\n\n                /**\n                 * Delete section.\n                 */\n                var doDelete = function() {\n\n                    if (!ajaxTracker.start('section_delete', el)) {\n                        // Already in progress.\n                        return;\n                    }\n\n                    var delProgress = M.util.get_string('deletingsection', 'theme_snap', sectionName);\n\n                    footerAlert.setTitle(delProgress);\n                    footerAlert.addAjaxLoading('');\n                    footerAlert.show();\n\n                    var params = {\n                        courseshortname: courseLib.courseConfig.shortname,\n                        action: 'delete',\n                        sectionnumber: sectionNum,\n                        value: 1\n                    };\n\n                    log.debug('Making course/rest.php section delete request', params);\n\n                    // Make ajax call.\n                    var ajaxPromises = ajax.call([\n                        {\n                            methodname: 'theme_snap_course_sections',\n                            args: params\n                        }\n                    ], true, true);\n\n                    // Handle ajax promises.\n                    ajaxPromises[0]\n                        .done(function(response) {\n                            // Update TOC.\n                            templates.render('theme_snap/course_toc', response.toc)\n                                .done(function(result) {\n                                    $('#course-toc').html($(result).html());\n                                    $(document).trigger('snapTOCReplaced');\n                                    // Remove section from DOM.\n                                    section.remove();\n                                    updateSections();\n\n                                    // Current section no longer exists so change location to previous section.\n                                    if (sectionNum >= $('.course-content > ul li.section').length) {\n                                        location.hash = 'section-' + (sectionNum - 1);\n                                    }\n                                    courseLib.showSection();\n                                    // We can't complete the action in the 'always' section because we want it to\n                                    // definitely be called after the section is removed from the DOM.\n                                    ajaxTracker.complete('section_delete');\n                                })\n                                .always(function() {\n                                    // Allow another request now this has finished.\n                                    footerAlert.hideAndReset();\n                                })\n                                .fail(function() {\n                                    ajaxTracker.complete('section_delete');\n                                });\n                        })\n                        .fail(function(response) {\n                            ajaxNotify.ifErrorShowBestMsg(response);\n                            footerAlert.hideAndReset();\n                            // Allow another request now this has finished.\n                            ajaxTracker.complete('section_delete');\n                        });\n                };\n\n                var delTitle = M.util.get_string('confirm', 'moodle');\n                var delConf = M.util.get_string('confirmdeletesection', 'moodle', sectionName);\n                var ok = M.util.get_string('deletesectionconfirm', 'theme_snap');\n                var cancel = M.util.get_string('cancel', 'moodle');\n                notification.confirm(delTitle, delConf, ok, cancel, doDelete);\n            };\n\n            /**\n             * Generic action handler for all asset actions.\n             * @param {event} e\n             * @param {domNode} triggerEl\n             */\n            var assetAction = function(e, triggerEl) {\n                e.preventDefault();\n\n                var assetEl = $($(triggerEl).parents('.snap-asset')[0]),\n                    cmid = Number(assetEl[0].id.replace('module-', '')),\n                    instanceName = assetEl.find('.instancename').text().trim(),\n                    action = $(triggerEl).data('action'),\n                    errActionKey = '',\n                    errMessageKey = '',\n                    errAction = '',\n                    errMessage = '',\n                    jsPendingKey = 'asset_' + action;\n\n                if (ajaxTracker.ajaxing(jsPendingKey)) {\n                    // Already in progress.\n                    // We check this because we don't want to show the confirmation dialog when in progress.\n                    return;\n                }\n\n                var actionAJAX = function() {\n                    if (!ajaxTracker.start(jsPendingKey, assetEl, '.snap-edit-asset-more')) {\n                        // Request already made.\n                        return;\n                    }\n\n                    var params = {\n                        'action': action,\n                        'sectionreturn': 0,\n                        'id': cmid\n                    };\n\n                    ajax.call([\n                        {\n                            methodname: 'core_course_edit_module',\n                            args: params\n                        }\n                    ], true, true)[0]\n                        .done(function(response) {\n                            ajaxNotify.ifErrorShowBestMsg(response, errAction, errMessage).done(function(errorShown) {\n                                ajaxTracker.complete(jsPendingKey);\n                                if (errorShown) {\n                                    log.debug('Ajax request fail');\n                                    return;\n                                } else {\n                                    log.debug('Ajax request successful');\n                                    if (action === 'delete') {\n                                        // Remove asset from DOM.\n                                        assetEl.remove();\n                                        // Remove asset searchable.\n                                        $('#toc-searchables li[data-id=\"' + cmid + '\"]').remove();\n                                    } else if (action === 'show') {\n                                        assetEl.removeClass('draft');\n                                    } else if (action === 'hide') {\n                                        assetEl.addClass('draft');\n                                    } else if (action === 'duplicate') {\n                                        assetEl.replaceWith(response);\n                                    }\n                                }\n                            });\n                        })\n                        .fail(function(response) {\n                            ajaxNotify.ifErrorShowBestMsg(response, errAction, errMessage).done(function() {\n                                ajaxTracker.complete(jsPendingKey);\n                            });\n                        })\n                        .always(function() {\n                            footerAlert.hideAndReset();\n                        });\n                };\n\n                /**\n                 * Get error strings incase of AJAX failure.\n                 * @returns {*|Promise}\n                 */\n                var getErrorStrings = function() {\n                    if (action === 'duplicate') {\n                        errActionKey = 'action:duplicateasset';\n                        errMessageKey = 'error:failedtoduplicateasset';\n                    } else if (action === 'show' || action === 'hide') {\n                        errActionKey = 'action:changeassetvisibility';\n                        errMessageKey = 'error:failedtochangeassetvisibility';\n                    } else if (action === 'delete') {\n                        errActionKey = 'action:deleteasset';\n                        errMessageKey = 'error:failedtodeleteasset';\n                    }\n                    return str.get_strings([\n                        {key: errActionKey, component: 'theme_snap'},\n                        {key: errMessageKey, component: 'theme_snap'}\n                    ]);\n                };\n\n                getErrorStrings().then(function(strings) {\n                    errAction = strings[0];\n                    errMessage = strings[0];\n                    if (action === 'delete') {\n                        // Create confirmation strings.\n                        var delConf = '',\n                            plugindata = {\n                                type: M.util.get_string('pluginname', assetEl.attr('class').match(/modtype_([^\\s]*)/)[1])\n                            };\n                        if (instanceName !== '') {\n                            plugindata.name = instanceName;\n                            delConf = M.util.get_string('deletechecktypename', 'moodle', plugindata);\n                        } else {\n                            delConf = M.util.get_string('deletechecktype', 'moodle', plugindata);\n                        }\n\n                        var delTitle = M.util.get_string('confirm', 'moodle');\n                        var ok = M.util.get_string('deleteassetconfirm', 'theme_snap', plugindata.type);\n                        var cancel = M.util.get_string('cancel', 'moodle');\n                        notification.confirm(delTitle, delConf, ok, cancel, actionAJAX);\n                    } else {\n                        actionAJAX();\n                    }\n                });\n            };\n\n            /**\n             * Ajax request to move asset to target.\n             * @param {object} target\n             */\n            var ajaxReqMoveAsset = function(target) {\n                var params = {};\n\n                log.debug('Move objects', movingObjects);\n\n                // Prepare request parameters\n                params.class = 'resource';\n\n                updateMovingMessage();\n\n                movingObject = movingObjects.shift();\n\n                params.id = Number(movingObject.id.replace('module-', ''));\n\n                if (target && !$(target).hasClass('snap-drop')) {\n                    params.beforeId = Number($(target)[0].id.replace('module-', ''));\n                } else {\n                    params.beforeId = 0;\n                }\n\n                if (document.body.id === \"page-site-index\") {\n                    params.sectionId = 1;\n                } else {\n                    if (target) {\n                        params.sectionId = parentSectionNumber(target);\n                    } else {\n                        params.sectionId = parentSectionNumber(movingObject);\n                    }\n                }\n\n                if (movingObjects.length > 0) {\n                    ajaxReqMoveGeneral(params, function() {\n                        $(target).before($(movingObject));\n                        // recurse\n                        ajaxReqMoveAsset(target);\n                    }, false);\n                } else {\n                    ajaxReqMoveGeneral(params, function() {\n                        $(target).before($(movingObject));\n                    }, true);\n                }\n\n            };\n\n            /**\n             * Ajax request to move section to target.\n             * @param {str|object} dropzone\n             */\n            var ajaxReqMoveSection = function(dropzone) {\n                var domTargetSection = parentSectionNumber(dropzone);\n                var currentSection = sectionNumber(movingObjects[0]);\n                var targetSection = currentSection < domTargetSection ?\n                        domTargetSection - 1 :\n                        domTargetSection;\n\n                var params = {\n                    \"class\": 'section',\n                    id: currentSection,\n                    value: targetSection\n                };\n\n                ajaxReqMoveGeneral(params, function() {\n\n                    // Update TOC chapters.\n                    ajax.call([\n                        {\n                            methodname: 'theme_snap_course_toc_chapters',\n                            args: {\n                                courseshortname: courseLib.courseConfig.shortname\n                            },\n                            done: function(response) {\n                                // Update TOC.\n                                templates.render('theme_snap/course_toc_chapters', response.chapters)\n                                    .done(function(result) {\n                                        // Update chapters.\n                                        $('#chapters').replaceWith(result);\n\n                                        // Move current section before target section.\n                                        $('#section-' + domTargetSection).before($('#section-' + currentSection));\n\n                                        // Update section ids, next previous links, etc.\n                                        updateSections();\n\n                                        // Navigate to section in its new location.\n                                        location.hash = 'section-' + targetSection;\n                                        courseLib.showSection();\n\n                                        // Finally, we have finished moving the section!\n                                        stopMoving();\n                                    });\n                            },\n                            fail: function(response) {\n                                ajaxNotify.ifErrorShowBestMsg(response);\n                                stopMoving();\n                            }\n                        }\n                    ], true, true);\n\n                }, true);\n            };\n\n            /**\n             * Listen for edit action clicks, hide, show, duplicate, etc..\n             */\n            var assetEditListeners = function() {\n                var actionSelectors = '.snap-asset-actions .js_snap_hide, ';\n                actionSelectors += '.snap-asset-actions .js_snap_show, ';\n                actionSelectors += '.snap-asset-actions .js_snap_delete, ';\n                actionSelectors += '.snap-asset-actions .js_snap_duplicate';\n\n                $(document).on('click', actionSelectors, function(e) {\n                    assetAction(e, this);\n                });\n            };\n\n            /**\n             * Generic section action handler.\n             *\n             * @param {string} action visibility, highlight\n             * @param {null|function} onComplete for when completed.\n             */\n            var sectionActionListener = function(action, onComplete) {\n\n                $('#region-main').on('click', '.snap-section-editing.actions .snap-' + action, function(e) {\n\n                    e.stopPropagation();\n                    e.preventDefault();\n\n                    var trigger = this;\n\n                    /**\n                     * Invalid section action exception.\n                     *\n                     * @param {string} action\n                     */\n                    var InvalidActionException = function(action) {\n                        this.message = 'Invalid section action: ' + action;\n                        this.name = 'invalidActionException';\n                    };\n\n                    // Check action is valid.\n                    var validactions = ['visibility', 'highlight'];\n                    if (validactions.indexOf(action) === -1) {\n                        throw new InvalidActionException(action);\n                    }\n\n                    if (!ajaxTracker.start('section_' + action, trigger)) {\n                        // Request already in progress.\n                        return;\n                    }\n\n                    // For toggling visibility.\n                    var toggle;\n                    if (action === 'visibility') {\n                        toggle = $(this).hasClass('snap-hide') ? 0 : 1;\n                    } else {\n                        // For toggling highlight/mark as current.\n                        toggle = $(this).attr('aria-pressed') === 'true' ? 0 : 1;\n                    }\n\n                    var sectionNumber = parentSectionNumber(this);\n                    var sectionActionsSelector = '#section-' + sectionNumber + ' .snap-section-editing';\n                    var actionSelector = sectionActionsSelector + ' .snap-' + action;\n\n\n                    // Make ajax call.\n                    var ajaxPromises = ajax.call([\n                        {\n                            methodname: 'theme_snap_course_sections',\n                            args: {\n                                courseshortname: courseLib.courseConfig.shortname,\n                                action: action,\n                                sectionnumber: sectionNumber,\n                                value: toggle\n                            }\n                        }\n                    ], true, true);\n\n                    // Handle ajax promises.\n                    ajaxPromises[0]\n                    .fail(function(response) {\n                        var errMessage, errAction;\n                        if (action === 'visibility') {\n                            errMessage = M.util.get_string('error:failedtochangesectionvisibility', 'theme_snap');\n                            errAction = M.util.get_string('action:changesectionvisibility', 'theme_snap');\n                        } else {\n                            errMessage = M.util.get_string('error:failedtohighlightsection', 'theme_snap');\n                            errAction = M.util.get_string('action:highlightsectionvisibility', 'theme_snap');\n                        }\n                        ajaxNotify.ifErrorShowBestMsg(response, errAction, errMessage).done(function() {\n                            // Allow another request now this has finished.\n                            ajaxTracker.complete('section_' + action);\n                        });\n                    }).always(function() {\n                        $(trigger).removeClass('ajaxing');\n                    }).done(function(response) {\n                        // Update section action and then reload TOC.\n                        return templates.render('theme_snap/course_action_section', response.actionmodel)\n                        .then(function(result) {\n                            $(actionSelector).replaceWith(result);\n                            $(actionSelector).focus();\n                            // Update TOC.\n                            return templates.render('theme_snap/course_toc', response.toc);\n                        }).then(function(result) {\n                            $('#course-toc').html($(result).html());\n                            $(document).trigger('snapTOCReplaced');\n                            if (onComplete && typeof (onComplete) === 'function') {\n                                var completion = onComplete(sectionNumber, toggle);\n                                if (completion && typeof (completion.always) === 'function') {\n                                    // Callback returns a promise, js no longer running.\n                                    completion.always(\n                                        function() {\n                                            // Allow another request now this has finished.\n                                            ajaxTracker.complete('section_' + action);\n                                        }\n                                    );\n                                } else {\n                                    // Callback does not return a promise, js no longer running.\n                                    // Allow another request now this has finished.\n                                    ajaxTracker.complete('section_' + action);\n                                }\n                            } else {\n                                // Allow another request now this has finished.\n                                ajaxTracker.complete('section_' + action);\n                            }\n                        });\n                    });\n                });\n            };\n\n            /**\n             * Highlight section on click.\n             */\n            var highlightSectionListener = function() {\n                sectionActionListener('highlight', function(sectionNumber) {\n                    $('#section-' + sectionNumber).toggleClass('current');\n\n                    // Reset sections which are not highlighted.\n                    var $notCurrent = $('li.section.main')\n                    .not('#section-' + sectionNumber)\n                    .not('#section-0').removeClass(\"current\");\n\n                    $notCurrent.each(function() {\n                        var highlighter = $(this).find('.snap-highlight');\n                        var sectionNumber = parentSectionNumber(highlighter);\n                        var newLink = $(highlighter).attr('href').replace(/(marker=)[0-9]+/ig, '$1' + sectionNumber);\n                        $(highlighter).attr('href', newLink).attr('aria-pressed', 'false');\n                    });\n                });\n            };\n\n            /**\n             * Delete section on click.\n             */\n            var deleteSectionListener = function() {\n                $(document).on('click', '.snap-section-editing.actions .snap-delete', function(e) {\n                    sectionDelete(e, this);\n                });\n            };\n\n            /**\n             * Toggle section visibility on click.\n             */\n            var toggleSectionListener = function() {\n                /**\n                 * Toggle hidden class and update section navigation.\n                 * @param {number} sectionNumber\n                 * @param {boolean} toggle\n                 * @returns {Promise}\n                 */\n                var manageHiddenClass = function(sectionNumber, toggle) {\n                    if (toggle === 0) {\n                        $('#section-' + sectionNumber).addClass('hidden');\n                    } else {\n                        $('#section-' + sectionNumber).removeClass('hidden');\n                    }\n\n                    // Update the section navigation either side of the current section.\n                    var selectors = [\n                        '#section-' + (sectionNumber - 1),\n                        '#section-' + (sectionNumber + 1)\n                    ];\n                    var selector = selectors.join(',');\n                    return updateSectionNavigation(selector);\n                };\n                sectionActionListener('visibility', manageHiddenClass);\n            };\n\n            /**\n             * Show footer alert for moving.\n             */\n            var footerAlertShowMove = function() {\n                footerAlert.show(function(e) {\n                    e.preventDefault();\n                    stopMoving();\n                });\n            };\n\n            /**\n             * When section move link is clicked, get the data we need and start the move.\n             */\n            var moveSectionListener = function() {\n                // Listen clicks on move links.\n                $(\"#region-main\").on('click', '.snap-section-editing.actions .snap-move', function(e) {\n                    e.stopPropagation();\n                    e.preventDefault();\n\n                    $('body').addClass('snap-move-inprogress');\n                    footerAlertShowMove();\n\n                    // Moving a section.\n                    var sectionNumber = parentSectionNumber(this);\n                    log.debug('Section is', sectionNumber);\n                    var section = $('#section-' + sectionNumber);\n                    var sectionName = section.find('.sectionname').text();\n\n                    log.debug('Moving this section', sectionName);\n                    movingObjects = [section];\n\n                    // This should never happen, but just in case...\n                    $('.section-moving').removeClass('section-moving');\n                    section.addClass('section-moving');\n                    $('a[href=\"#section-' + sectionNumber + '\"]').parent('li').addClass('section-moving');\n                    $('body').addClass('snap-move-section');\n\n                    var title = M.util.get_string('moving', 'theme_snap', sectionName);\n                    footerAlert.setTitle(title);\n\n                    $('.section-drop').each(function() {\n                        var sectionDropMsg = M.util.get_string('movingdropsectionhelp', 'theme_snap',\n                            {moving: sectionName, before: $(this).data('title')}\n                        );\n                        $(this).html(sectionDropMsg);\n                    });\n\n                    footerAlert.setSrNotice(M.util.get_string('movingstartedhelp', 'theme_snap', sectionName));\n                });\n            };\n\n            /**\n             * Add drop zones at the end of sections.\n             */\n            var addAfterDrops = function() {\n                if (document.body.id === \"page-site-index\") {\n                    $('#region-main .sitetopic ul.section').append(\n                        '<li class=\"snap-drop asset-drop\">' +\n                        '<div class=\"asset-wrapper\">' +\n                        '<a href=\"#\">' +\n                        M.util.get_string('movehere', 'theme_snap') +\n                        '</a>' +\n                        '</div>' +\n                        '</li>');\n                } else {\n                    $('li.section .content ul.section').append(\n                        '<li class=\"snap-drop asset-drop\">' +\n                        '<div class=\"asset-wrapper\">' +\n                        '<a href=\"#\">' +\n                        M.util.get_string('movehere', 'theme_snap') +\n                        '</a>' +\n                        '</div>' +\n                        '</li>');\n                }\n            };\n\n            /**\n             * Add listener for move checkbox.\n             */\n            var assetMoveListener = function() {\n                $(\"#region-main\").on('change', '.js-snap-asset-move', function(e) {\n                    e.stopPropagation();\n\n                    var asset = $(this).parents('.snap-asset')[0];\n\n                    // Make sure after drop is at the end of section.\n                    var section = $(asset).parents('ul.section')[0];\n                    var afterdrop = $(section).find('li.snap-drop.asset-drop');\n                    $(section).append(afterdrop);\n\n                    if (movingObjects.length === 0) {\n                        // Moving asset - activity or resource.\n                        // Initiate move.\n                        var assetname = $(asset).find('.snap-asset-link .instancename').html();\n\n                        log.debug('Moving this asset', assetname);\n\n                        var classes = $(asset).attr('class'),\n                            regex = /(?=snap-mime)([a-z0-9\\-]*)/;\n                        var assetclasses = regex.exec(classes);\n                        classes = '';\n                        if (assetclasses) {\n                            classes = assetclasses.join(' ');\n                        }\n                        log.debug('Moving this class', classes);\n                        $(asset).addClass('asset-moving');\n                        $('.snap-asset button').attr('disabled','disabled');\n                        $(asset).find('button').removeAttr('disabled');\n                        $('.snap-asset .snap-asset-content a').attr('tabindex','-1');\n                        $(asset).find('a').removeAttr('tabindex');\n\n                        $(asset).find('.js-snap-asset-move').prop('checked', 'checked');\n\n                        $('body').addClass('snap-move-inprogress');\n                        $('body').addClass('snap-move-asset');\n\n                    }\n\n                    if ($(this).prop('checked')) {\n                        // Add asset to moving array.\n                        movingObjects.push(asset);\n                        $(asset).find('a').removeAttr('tabindex');\n                        $(asset).find('button').removeAttr('disabled');\n                        $(asset).addClass('asset-moving');\n                    } else {\n                        // Remove from moving array.\n                        removeMovingObject(asset);\n                        // Remove moving class\n                        $(asset).find('.snap-asset-content a').attr('tabindex','-1');\n                        $(asset).find('button').attr('disabled','disabled');\n                        $(asset).removeClass('asset-moving');\n                        if (movingObjects.length === 0) {\n                            // Nothing is ticked for moving, cancel the move.\n                            stopMoving();\n                        }\n                    }\n                    footerAlertShowMove();\n                    updateMovingMessage();\n                });\n            };\n\n            /**\n             * When an asset or drop zone is clicked, execute move.\n             */\n            var movePlaceListener = function() {\n                $(document).on('click', '.snap-move-note, .snap-drop', function(e) {\n                    log.debug('Snap drop clicked', e);\n                    if (movingObjects) {\n                        e.stopPropagation();\n                        e.preventDefault();\n                        if ($('body').hasClass('snap-move-section')) {\n                            ajaxReqMoveSection(this);\n                        } else {\n                            var target;\n                            if ($(this).hasClass('snap-drop')) {\n                                target = this;\n                            } else {\n                                target = $(this).closest('.snap-asset');\n                            }\n                            ajaxReqMoveAsset(target);\n                        }\n                    }\n                });\n            };\n\n            /**\n             * Add listeners.\n             */\n            var addListeners = function() {\n                moveSectionListener();\n                toggleSectionListener();\n                highlightSectionListener();\n                deleteSectionListener();\n                assetMoveListener();\n                movePlaceListener();\n                assetEditListeners();\n                addAfterDrops();\n                $('body').addClass('snap-course-listening');\n            };\n\n            /**\n             * Override core functions.\n             */\n            var overrideCore = function() {\n                // Check M.course exists (doesn't exist in social format).\n                if (M.course && M.course.resource_toolbox) {\n                    /* eslint-disable camelcase */\n                    M.course.resource_toolbox.handle_resource_dim = function(button, activity, action) {\n                        return (action === 'hide') ? 0 : 1;\n                    };\n                    /* eslint-enable camelcase */\n                }\n            };\n\n            /**\n             * Initialise script.\n             */\n            var initialise = function() {\n                // Add listeners.\n                addListeners();\n\n                // Override core functions\n                util.whenTrue(function() {\n                    return M.course && M.course.init_section_toolbox;\n                }, function() {\noverrideCore();\n}, true);\n\n            };\n            initialise();\n        }\n    };\n\n});\n"],"file":"section_asset_management.min.js"}